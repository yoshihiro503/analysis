
<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Module mathcomp.analysis.kernel</title>
<meta name="description" content="Documentation of Coq module mathcomp.analysis.kernel" />
<link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
<script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/markdown-it-texmath/texmath.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/darkmode-js@1.5.7/lib/darkmode-js.min.js"></script>
<link href="coq2html.css" rel="stylesheet" type="text/css" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type="text/javascript" src="coq2html.js"> </script>
</head>

<body onload="init()">

  <main>
    <div class="sidebar">
      <h2>Files</h2>
      
    </div>

  <div class="coq">

    <div class="content">
      <p><a href="./index.html">Top</a></p>
      <h1 class="title">Module mathcomp.analysis.kernel</h1>
<span class="vernacular">From</span><span class="id"> HB</span><span class="vernacular"> Require</span><span class="vernacular"> Import</span><span class="id"> structures</span>.<br/>
<span class="vernacular">From</span><span class="id"> mathcomp</span><span class="vernacular"> Require</span><span class="vernacular"> Import</span><span class="id"> all_ssreflect</span><span class="id"> ssralg</span><span class="id"> ssrnum</span><span class="id"> ssrint</span><span class="id"> interval</span><span class="id"> finmap</span>.<br/>
<span class="vernacular">From</span><span class="id"> mathcomp</span><span class="vernacular"> Require</span><span class="vernacular"> Import</span><span class="id"> mathcomp_extra</span><span class="id"> boolp</span><span class="id"> classical_sets</span><span class="id"> functions</span>.<br/>
<span class="vernacular">From</span><span class="id"> mathcomp</span><span class="vernacular"> Require</span><span class="vernacular"> Import</span><span class="id"> cardinality</span><span class="id"> fsbigop</span><span class="id"> reals</span><span class="id"> ereal</span><span class="id"> signed</span>.<br/>
<span class="vernacular">From</span><span class="id"> mathcomp</span><span class="vernacular"> Require</span><span class="vernacular"> Import</span><span class="id"> topology</span><span class="id"> normedtype</span><span class="id"> sequences</span><span class="id"> esum</span><span class="id"> measure</span>.<br/>
<span class="vernacular">From</span><span class="id"> mathcomp</span><span class="vernacular"> Require</span><span class="vernacular"> Import</span><span class="id"> numfun</span><span class="id"> lebesgue_measure</span><span class="id"> lebesgue_integral</span>.<br/>
<br/>
<div class="ssrdoc md">
# Kernels

This file provides a formation of kernels, s-finite kernels, finite
kernels, subprobability kernels, and probability kernels. The main
formalized result is the fact that s-finite kernels are stable by
composition.
Reference:
- R. Affeldt, C. Cohen, A. Saito. Semantics of probabilistic programs
  using s-finite kernels in Coq. CPP 2023

```
      R.-ker X ~&gt; Y == kernel from X to Y where X and Y are of type
                       measurableType
                       The HB class is Kernel.
  measure_fam_uub k == the kernel k is uniformly upper-bounded
    R.-sfker X ~&gt; Y == s-finite kernel
                       The HB class is SFiniteKernel.
     R.-fker X ~&gt; Y == finite kernel
                       The HB class is FiniteKernel.
    R.-spker X ~&gt; Y == subprobability kernel
                       The HB class is SubProbabilityKernel.
     R.-pker X ~&gt; Y == probability kernel
                       The HB class is ProbabilityKernel.
            kseries == countable sum of kernels
                       It is declared as an instance of the structure
                       Kernel. It is also an instance of the structure
                       SFiniteKernel if the sum is over s-finite kernels.
              kzero == kernel defined using the mzero measure
          kdirac mf == kernel defined by a measurable function
     kprobability m == kernel defined by a probability measure
         kadd k1 k2 == lifting of the addition of measures to kernels
             l \; k == composition of kernels
```

</div>
<br/>
<span class="gallina-kwd">Set</span><span class="vernacular"> Implicit</span><span class="vernacular"> Arguments</span>.<br/>
<span class="vernacular">Unset</span><span class="vernacular"> Strict</span><span class="vernacular"> Implicit</span>.<br/>
<span class="vernacular">Unset</span><span class="vernacular"> Printing</span><span class="vernacular"> Implicit</span><span class="vernacular"> Defensive</span>.<br/>
<span class="vernacular">Import</span><span class="id"> Order</span>.<span class="id">TTheory</span><span class="id"> GRing</span>.<span class="id">Theory</span><span class="id"> Num</span>.<span class="id">Def</span><span class="id"> Num</span>.<span class="id">Theory</span>.<br/>
<span class="vernacular">Import</span><span class="id"> numFieldTopology</span>.<span class="vernacular">Exports</span>.<br/>
<br/>
<span class="vernacular">Local</span><span class="vernacular"> Open</span><span class="vernacular"> Scope</span><span class="id"> classical_set_scope</span>.<br/>
<span class="vernacular">Local</span><span class="vernacular"> Open</span><span class="vernacular"> Scope</span><span class="id"> ring_scope</span>.<br/>
<span class="vernacular">Local</span><span class="vernacular"> Open</span><span class="vernacular"> Scope</span><span class="id"> ereal_scope</span>.<br/>
<br/>
<span class="vernacular">Reserved</span><span class="vernacular"> Notation</span> <span class="id">&quot;R .-ker X ~&gt; Y&quot;</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">at</span><span class="id"> level</span><span class="id"> 42,</span><span class="id"> format</span> <span class="id">&quot;R .-ker  X  ~&gt;  Y&quot;</span>).<br/>
<span class="vernacular">Reserved</span><span class="vernacular"> Notation</span> <span class="id">&quot;R .-sfker X ~&gt; Y&quot;</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">at</span><span class="id"> level</span><span class="id"> 42,</span><span class="id"> format</span> <span class="id">&quot;R .-sfker  X  ~&gt;  Y&quot;</span>).<br/>
<span class="vernacular">Reserved</span><span class="vernacular"> Notation</span> <span class="id">&quot;R .-fker X ~&gt; Y&quot;</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">at</span><span class="id"> level</span><span class="id"> 42,</span><span class="id"> format</span> <span class="id">&quot;R .-fker  X  ~&gt;  Y&quot;</span>).<br/>
<span class="vernacular">Reserved</span><span class="vernacular"> Notation</span> <span class="id">&quot;R .-spker X ~&gt; Y&quot;</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">at</span><span class="id"> level</span><span class="id"> 42,</span><span class="id"> format</span> <span class="id">&quot;R .-spker  X  ~&gt;  Y&quot;</span>).<br/>
<span class="vernacular">Reserved</span><span class="vernacular"> Notation</span> <span class="id">&quot;R .-pker X ~&gt; Y&quot;</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">at</span><span class="id"> level</span><span class="id"> 42,</span><span class="id"> format</span> <span class="id">&quot;R .-pker  X  ~&gt;  Y&quot;</span>).<br/>
<br/>
<span class="id">HB</span>.<span class="id">mixin</span><span class="vernacular"> Record</span><span class="id"> isKernel</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">measurable_kernel</span><span class="id"> :</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">k</span><span class="id"> ^~</span><span class="id"> U</span>)<span class="id"> }</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=kernel</span>)<span class="id">]</span><br/>
<span class="id">HB</span>.<span class="id">structure</span><span class="vernacular"> Definition</span><span class="id"> Kernel</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">{</span><span class="id"> k</span><span class="id"> &amp;</span><span class="id"> isKernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> }</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;R .-ker X ~&gt; Y&quot;</span><span class="id"> :=</span> (<span class="id">kernel</span><span class="id"> X%type</span><span class="id"> Y</span><span class="id"> R</span>).<br/>
<br/>
<span class="vernacular">Arguments</span><span class="id"> measurable_kernel</span><span class="id"> {_</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _}</span><span class="id"> _</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> kernel_measurable_eq_cst</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">T</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">T'</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">f</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> T</span><span class="id"> ~&gt;</span><span class="id"> T'</span>)<span class="id"> k</span><span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable</span><span class="id"> [set</span><span class="id"> t</span><span class="id"> |</span><span class="id"> f</span><span class="id"> t</span><span class="id"> [set:</span><span class="id"> T']</span><span class="id"> ==</span><span class="id"> k]</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">rewrite</span><span class="id"> [X</span><span class="gallina-kwd"> in</span><span class="id"> measurable</span><span class="id"> X]</span>(_<span class="id"> :</span><span class="id"> _</span><span class="id"> =</span> (<span class="id">f</span><span class="id"> ^~</span><span class="id"> setT</span>)<span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> k]</span>)<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/seteqP;</span><span class="id"> split</span><span class="id"> =&gt;</span><span class="id"> t/=</span><span class="id"> /eqP</span>.<br/>
<span class="id">have</span><span class="id"> /</span>(_<span class="id"> measurableT</span><span class="id"> [set</span><span class="id"> k]</span>)<span class="id"> :=</span><span class="id"> measurable_kernel</span><span class="id"> f</span><span class="id"> setT</span><span class="id"> measurableT</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> setTI;</span><span class="id"> exact</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Lemma</span><span class="id"> kernel_measurable_neq_cst</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">T</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">T'</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)  (<span class="id">f</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> T</span><span class="id"> ~&gt;</span><span class="id"> T'</span>)<span class="id"> k</span><span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable</span><span class="id"> [set</span><span class="id"> t</span><span class="id"> |</span><span class="id"> f</span><span class="id"> t</span><span class="id"> [set:</span><span class="id"> T']</span><span class="id"> !=</span><span class="id"> k]</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">rewrite</span><span class="id"> [X</span><span class="gallina-kwd"> in</span><span class="id"> measurable</span><span class="id"> X]</span>(_<span class="id"> :</span><span class="id"> _</span><span class="id"> =</span> (<span class="id">f</span><span class="id"> ^~</span><span class="id"> setT</span>)<span class="id"> @^-1`</span><span class="id"> [set~</span><span class="id"> k]</span>)<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/seteqP;</span><span class="id"> split</span><span class="id"> =&gt;</span><span class="id"> t</span><span class="id"> /eqP</span>.<br/>
<span class="id">have</span><span class="id"> /</span>(_<span class="id"> measurableT</span><span class="id"> [set~</span><span class="id"> k]</span>)<span class="id"> :=</span><span class="id"> measurable_kernel</span><span class="id"> f</span><span class="id"> setT</span><span class="id"> measurableT</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> setTI;</span><span class="id"> apply</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> exact:</span><span class="id"> measurableC</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Lemma</span><span class="id"> kernel_measurable_fun_eq_cst</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">T</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">T'</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">f</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> T</span><span class="id"> ~&gt;</span><span class="id"> T'</span>)<span class="id"> k</span><span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> T]</span> (<span class="gallina-kwd">fun</span><span class="id"> t</span><span class="id"> =&gt;</span><span class="id"> f</span><span class="id"> t</span><span class="id"> [set:</span><span class="id"> T']</span><span class="id"> ==</span><span class="id"> k</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> _</span><span class="id"> /=</span><span class="id"> B</span><span class="id"> mB;</span><span class="id"> rewrite</span><span class="id"> setTI</span>.<br/>
<span class="id">have</span><span class="id"> [/eqP-&gt;|/eqP-&gt;|/eqP-&gt;|/eqP-&gt;]</span><span class="id"> :=</span><span class="id"> set_bool</span><span class="id"> B</span>.<br/>
<span class="id">-</span><span class="id"> exact:</span><span class="id"> kernel_measurable_eq_cst</span>.<br/>
<span class="id">-</span><span class="id"> rewrite</span> (_<span class="id"> :</span><span class="id"> _</span><span class="id"> @^-1`</span><span class="id"> _</span><span class="id"> =</span><span class="id"> [set</span><span class="id"> b</span><span class="id"> |</span><span class="id"> f</span><span class="id"> b</span><span class="id"> setT</span><span class="id"> !=</span><span class="id"> k]</span>)<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/seteqP;</span><span class="id"> split</span><span class="id"> =&gt;</span><span class="id"> [t</span><span class="id"> /negbT//|t</span><span class="id"> /negbTE]</span>.<br/>
&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> kernel_measurable_neq_cst</span>.<br/>
<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> preimage_set0</span>.<br/>
<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> preimage_setT</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Lemma</span><span class="id"> eq_kernel</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">T</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">T'</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">k1</span><span class="id"> k2</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> T</span><span class="id"> ~&gt;</span><span class="id"> T'</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> k1</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> k2</span><span class="id"> x</span><span class="id"> U</span>)<span class="id"> -&gt;</span><span class="id"> k1</span><span class="id"> =</span><span class="id"> k2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move:</span><span class="id"> k1</span><span class="id"> k2</span><span class="id"> =&gt;</span><span class="id"> [m1</span><span class="id"> [[?]]]</span><span class="id"> [m2</span><span class="id"> [[?]]]</span><span class="id"> /=</span><span class="id"> k12</span>.<br/>
<span class="id">have</span><span class="id"> ?</span><span class="id"> :</span><span class="id"> m1</span><span class="id"> =</span><span class="id"> m2</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> t;</span><span class="id"> apply/eq_measure;</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> U;</span><span class="id"> rewrite</span><span class="id"> k12</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> subst</span><span class="id"> m1;</span><span class="id"> f_equal;</span><span class="id"> f_equal;</span><span class="id"> f_equal;</span><span class="id"> apply/Prop_irrelevance</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Section</span><span class="id"> kseries</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-ker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<span class="id">^nat</span>.<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> kseries</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> [the</span><span class="id"> measure</span><span class="id"> _</span><span class="id"> _</span><span class="id"> of</span><span class="id"> mseries</span> (<span class="id">k</span><span class="id"> ^~</span><span class="id"> x</span>)<span class="id"> 0]</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_kseries</span> (<span class="id">U</span><span class="id"> :</span><span class="id"> set</span><span class="id"> Y</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">kseries</span><span class="id"> ^~</span><span class="id"> U</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> mU</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> ge0_emeasurable_fun_sum</span><span class="id"> =&gt;</span><span class="id"> //</span><span class="id"> n</span><span class="id"> _;</span><span class="id"> exact/measurable_kernel</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">isKernel</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> kseries</span><span class="id"> measurable_fun_kseries</span>.<br/>
<br/>
<span class="vernacular">End</span><span class="id"> kseries</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> integral_kseries</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">k</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-ker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<span class="id">^nat</span>) (<span class="id">f</span><span class="id"> :</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R</span>)<span class="id"> x</span><span class="id"> :</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span><span class="id"> y,</span><span class="id"> 0</span><span class="id"> &lt;=</span><span class="id"> f</span><span class="id"> y</span>)<span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> f</span><span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">\int[kseries</span><span class="id"> k</span><span class="id"> x]_y</span> (<span class="id">f</span><span class="id"> y</span>)<span class="id"> =</span><span class="id"> \sum_</span>(<span class="id">i</span><span class="id"> &lt;oo</span>)<span class="id"> \int[k</span><span class="id"> i</span><span class="id"> x]_y</span> (<span class="id">f</span><span class="id"> y</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> f0</span><span class="id"> mf;</span><span class="id"> rewrite</span><span class="id"> /kseries/=</span><span class="id"> ge0_integral_measure_series</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Section</span><span class="id"> measure_fam_uub</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> numFieldType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>.<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> measure_fam_uub</span><span class="id"> :=</span><span class="gallina-kwd"> exists</span><span class="id"> r,</span><span class="gallina-kwd"> forall</span><span class="id"> x,</span><span class="id"> k</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> &lt;</span><span class="id"> r%:E</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measure_fam_uubP</span><span class="id"> :</span><span class="id"> measure_fam_uub</span><span class="id"> &lt;-&gt;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span><span class="id"> r</span><span class="id"> :</span><span class="id"> {posnum</span><span class="id"> R},</span><span class="gallina-kwd"> forall</span><span class="id"> x,</span><span class="id"> k</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> &lt;</span><span class="id"> r%:num%:E</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">split</span><span class="id"> =&gt;</span><span class="id"> [|]</span><span class="id"> [r</span><span class="id"> kr];</span><span class="id"> last</span><span class="gallina-kwd"> by</span><span class="gallina-kwd"> exists</span><span class="id"> r%:num</span>.<br/>
<span class="id">suff</span><span class="id"> r_gt0</span><span class="id"> :</span> (<span class="id">0</span><span class="id"> &lt;</span><span class="id"> r</span>)<span class="id">%R</span><span class="gallina-kwd"> by</span><span class="gallina-kwd"> exists</span> (<span class="id">PosNum</span><span class="id"> r_gt0</span>).<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> -lte_fin;</span><span class="id"> apply:</span> (<span class="id">le_lt_trans</span><span class="id"> _</span> (<span class="id">kr</span><span class="id"> point</span>)).<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> measure_fam_uub</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">mixin</span><span class="vernacular"> Record</span><span class="id"> Kernel_isSFinite_subdef</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">sfinite_kernel_subdef</span><span class="id"> :</span><span class="gallina-kwd"> exists2</span><span class="id"> s</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-ker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<span class="id">^nat,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> n,</span><span class="id"> measure_fam_uub</span> (<span class="id">s</span><span class="id"> n</span>)<span class="id"> &amp;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> k</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> kseries</span><span class="id"> s</span><span class="id"> x</span><span class="id"> U</span><span class="id"> }</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">structure</span><span class="vernacular"> Definition</span><span class="id"> SFiniteKernel</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">{</span><span class="id"> k</span><span class="id"> of</span><span class="id"> @Kernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> R</span><span class="id"> k</span><span class="id"> &amp;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">Kernel_isSFinite_subdef</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> }</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;R .-sfker X ~&gt; Y&quot;</span><span class="id"> :=</span> (<span class="id">SFiniteKernel</span>.<span class="id">type</span><span class="id"> X%type</span><span class="id"> Y</span><span class="id"> R</span>).<br/>
<span class="vernacular">Arguments</span><span class="id"> sfinite_kernel_subdef</span><span class="id"> {_</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _}</span><span class="id"> _</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> eq_sfkernel</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">T</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">T'</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">k1</span><span class="id"> k2</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> T</span><span class="id"> ~&gt;</span><span class="id"> T'</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> k1</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> k2</span><span class="id"> x</span><span class="id"> U</span>)<span class="id"> -&gt;</span><span class="id"> k1</span><span class="id"> =</span><span class="id"> k2</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move:</span><span class="id"> k1</span><span class="id"> k2</span><span class="id"> =&gt;</span><span class="id"> [m1</span><span class="id"> [[?]</span><span class="id"> [?]]]</span><span class="id"> [m2</span><span class="id"> [[?]</span><span class="id"> [?]]]</span><span class="id"> /=</span><span class="id"> k12</span>.<br/>
<span class="id">have</span><span class="id"> ?</span><span class="id"> :</span><span class="id"> m1</span><span class="id"> =</span><span class="id"> m2</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> t;</span><span class="id"> apply/eq_measure;</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> U;</span><span class="id"> rewrite</span><span class="id"> k12</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> subst</span><span class="id"> m1;</span><span class="id"> f_equal;</span><span class="id"> f_equal;</span><span class="id"> f_equal;</span><span class="id"> apply/Prop_irrelevance</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">mixin</span><span class="vernacular"> Record</span><span class="id"> SFiniteKernel_isFinite</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">measure_uub</span><span class="id"> :</span><span class="id"> measure_fam_uub</span><span class="id"> k</span><span class="id"> }</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=finite_kernel</span>)<span class="id">]</span><br/>
<span class="id">HB</span>.<span class="id">structure</span><span class="vernacular"> Definition</span><span class="id"> FiniteKernel</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">{</span><span class="id"> k</span><span class="id"> of</span><span class="id"> @SFiniteKernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> k</span><span class="id"> &amp;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">SFiniteKernel_isFinite</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> }</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;R .-fker X ~&gt; Y&quot;</span><span class="id"> :=</span> (<span class="id">finite_kernel</span><span class="id"> X%type</span><span class="id"> Y</span><span class="id"> R</span>).<br/>
<span class="vernacular">Arguments</span><span class="id"> measure_uub</span><span class="id"> {_</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _}</span><span class="id"> _</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">factory</span><span class="vernacular"> Record</span><span class="id"> Kernel_isFinite</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> of</span><span class="id"> isKernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> k</span><span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">measure_uub</span><span class="id"> :</span><span class="id"> measure_fam_uub</span><span class="id"> k</span><span class="id"> }</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> kzero</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> kzero</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span><span class="id"> _</span><span class="id"> :</span><span class="id"> X</span><span class="id"> =&gt;</span><span class="id"> [the</span><span class="id"> measure</span><span class="id"> _</span><span class="id"> _</span><span class="id"> of</span><span class="id"> mzero]</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> measurable_fun_kzero</span><span class="id"> U</span><span class="id"> :</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">kzero</span><span class="id"> ^~</span><span class="id"> U</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> ?/=;</span><span class="id"> exact:</span><span class="id"> measurable_cst</span>. Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@isKernel</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> kzero</span><span class="id"> measurable_fun_kzero</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> kzero_uub</span><span class="id"> :</span><span class="id"> measure_fam_uub</span><span class="id"> kzero</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd"> by</span><span class="gallina-kwd"> exists</span><span class="id"> 1%R</span><span class="id"> =&gt;</span><span class="id"> /=</span><span class="id"> t;</span><span class="id"> rewrite</span><span class="id"> /mzero/=</span>. Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> kzero</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">builders</span><span class="vernacular"> Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> k</span><span class="id"> of</span><span class="id"> Kernel_isFinite</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> sfinite_finite</span><span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists2</span><span class="id"> k_</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-ker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span>)<span class="id">^nat,</span><span class="gallina-kwd"> forall</span><span class="id"> n,</span><span class="id"> measure_fam_uub</span> (<span class="id">k_</span><span class="id"> n</span>)<span class="id"> &amp;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> k</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> mseries</span> (<span class="id">k_</span><span class="id"> ^~</span><span class="id"> x</span>)<span class="id"> 0</span><span class="id"> U</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd">exists</span> (<span class="gallina-kwd">fun</span><span class="id"> n</span><span class="id"> =&gt;</span><span class="gallina-kwd"> if</span><span class="id"> n</span><span class="id"> is</span><span class="id"> O</span><span class="gallina-kwd"> then</span><span class="id"> [the</span><span class="id"> _</span>.<span class="id">-ker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span><span class="id"> of</span><span class="id"> k]</span><span class="gallina-kwd"> else</span><br/>
&nbsp;&nbsp;<span class="id">[the</span><span class="id"> _</span>.<span class="id">-ker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span><span class="id"> of</span><span class="id"> @kzero</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R]</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> case</span><span class="id"> =&gt;</span><span class="id"> [|_];</span><span class="id"> [exact:</span><span class="id"> measure_uub|exact:</span><span class="id"> kzero_uub]</span>.<br/>
<span class="id">move=&gt;</span><span class="id"> t</span><span class="id"> U</span><span class="id"> mU/=;</span><span class="id"> rewrite</span><span class="id"> /mseries</span>.<br/>
<span class="id">rewrite</span> (<span class="id">nneseries_split</span><span class="id"> _</span><span class="id"> 1%N</span>)<span class="id">//</span><span class="id"> big_mkord</span><span class="id"> big_ord_recl/=</span><span class="id"> big_ord0</span><span class="id"> adde0</span>.<br/>
<span class="id">rewrite</span><span class="id"> ereal_series</span> (<span class="id">@eq_eseriesr</span><span class="id"> _</span><span class="id"> _</span> (<span class="id">fun=&gt;</span><span class="id"> 0%E</span>))<span class="id">;</span><span class="id"> last</span><span class="gallina-kwd"> by</span><span class="id"> case</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> eseries0//</span><span class="id"> adde0</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@Kernel_isSFinite_subdef</span>.<span class="id">Build</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> sfinite_finite</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@SFiniteKernel_isFinite</span>.<span class="id">Build</span> <span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> measure_uub</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> sfinite</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>).<br/>
<span class="vernacular">Variables</span> (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>).<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> s</span><span class="id"> :</span> (<span class="id">X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id">^nat</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">let:</span><span class="id"> exist2</span><span class="id"> x</span><span class="id"> _</span><span class="id"> _</span><span class="id"> :=</span><span class="id"> cid2</span> (<span class="id">sfinite_kernel_subdef</span><span class="id"> k</span>)<span class="gallina-kwd"> in</span><span class="id"> x</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> ms</span><span class="id"> n</span><span class="id"> :</span><span class="id"> @isKernel</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span> (<span class="id">s</span><span class="id"> n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">split;</span><span class="id"> rewrite</span><span class="id"> /s;</span><span class="id"> case:</span><span class="id"> cid2</span><span class="id"> =&gt;</span><span class="id"> /=</span><span class="id"> s'</span><span class="id"> s'_uub</span><span class="id"> kE</span>.<br/>
<span class="id">exact:</span><span class="id"> measurable_kernel</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> n</span><span class="id"> :=</span><span class="id"> ms</span><span class="id"> n</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> s_uub</span><span class="id"> n</span><span class="id"> :</span><span class="id"> measure_fam_uub</span> (<span class="id">s</span><span class="id"> n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> /s;</span><span class="id"> case:</span><span class="id"> cid2</span>. Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> n</span><span class="id"> :=</span><span class="id"> @Kernel_isFinite</span>.<span class="id">Build</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span> (<span class="id">s</span><span class="id"> n</span>) (<span class="id">s_uub</span><span class="id"> n</span>).<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> sfinite_kernel</span><span class="id"> :</span><span class="gallina-kwd"> exists</span><span class="id"> s</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<span class="id">^nat,</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> k</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> kseries</span><span class="id"> s</span><span class="id"> x</span><span class="id"> U</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd">exists</span> (<span class="gallina-kwd">fun</span><span class="id"> n</span><span class="id"> =&gt;</span><span class="id"> [the</span><span class="id"> _</span>.<span class="id">-fker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span><span class="id"> of</span><span class="id"> s</span><span class="id"> n]</span>)<span class="id"> =&gt;</span><span class="id"> x</span><span class="id"> U</span><span class="id"> mU</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> /s</span><span class="id"> /=</span><span class="id"> /s;</span><span class="gallina-kwd"> by</span><span class="id"> case:</span><span class="id"> cid2</span><span class="id"> =&gt;</span><span class="id"> ?</span><span class="id"> ?</span><span class="id"> -&gt;</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> sfinite</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> sfinite_kernel_measure</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">Z</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> Z</span><span class="id"> ~&gt;</span><span class="id"> X</span>) (<span class="id">z</span><span class="id"> :</span><span class="id"> Z</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">sfinite_measure</span> (<span class="id">k</span><span class="id"> z</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> [s</span><span class="id"> ks]</span><span class="id"> :=</span><span class="id"> sfinite_kernel</span><span class="id"> k</span>.<br/>
<span class="gallina-kwd">exists</span> (<span class="id">s</span><span class="id"> ^~</span><span class="id"> z</span>).<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span><span class="id"> n;</span><span class="id"> have</span><span class="id"> [r</span><span class="id"> snr]</span><span class="id"> :=</span><span class="id"> measure_uub</span> (<span class="id">s</span><span class="id"> n</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> lty_fin_num_fun;</span><span class="id"> rewrite</span> (<span class="id">lt_le_trans</span> (<span class="id">snr</span><span class="id"> _</span>))<span class="id">//</span><span class="id"> leey</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> U</span><span class="id"> mU;</span><span class="id"> rewrite</span><span class="id"> ks</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@Kernel_isFinite</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> R</span> (<span class="id">@kzero</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">@kzero_uub</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span>).<br/>
<br/>
<span class="id">HB</span>.<span class="id">factory</span><span class="vernacular"> Record</span><span class="id"> Kernel_isSFinite</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> of</span><span class="id"> isKernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> k</span><span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">sfinite</span><span class="id"> :</span><span class="gallina-kwd"> exists</span><span class="id"> s</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<span class="id">^nat,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> k</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> kseries</span><span class="id"> s</span><span class="id"> x</span><span class="id"> U</span><span class="id"> }</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">builders</span><span class="vernacular"> Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> k</span><span class="id"> of</span><span class="id"> Kernel_isSFinite</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> sfinite_subdef</span><span class="id"> :</span><span class="id"> Kernel_isSFinite_subdef</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">split;</span><span class="id"> have</span><span class="id"> [s</span><span class="id"> sE]</span><span class="id"> :=</span><span class="id"> sfinite;</span><span class="gallina-kwd"> exists</span><span class="id"> s</span><span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> n;</span><span class="id"> exact:</span><span class="id"> measure_uub</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span> <span class="id"> sfinite_subdef</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> sfkseries</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variables</span><span class="id"> k</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-sfker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<span class="id">^nat</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> sfinite_kseries</span><span class="id"> :</span><span class="gallina-kwd"> exists2</span><span class="id"> k_</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-ker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span>)<span class="id">^nat,</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> n,</span><span class="id"> measure_fam_uub</span> (<span class="id">k_</span><span class="id"> n</span>)<span class="id"> &amp;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> kseries</span><span class="id"> k</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> mseries</span> (<span class="id">k_</span><span class="id"> ^~</span><span class="id"> x</span>)<span class="id"> 0</span><span class="id"> U</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> /ppcard_eqP[f]</span><span class="id"> :</span> (<span class="id">[set:</span><span class="id"> nat]</span><span class="id"> #=</span><span class="id"> [set:</span><span class="id"> nat</span><span class="id"> *</span><span class="id"> nat]</span>)<span class="id">%card</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> card_eq_sym;</span><span class="id"> exact:</span><span class="id"> card_nat2</span>.<br/>
<span class="id">pose</span><span class="id"> p</span><span class="id"> n</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<span class="id">^nat</span><span class="id"> :=</span><span class="id"> sval</span> (<span class="id">cid</span> (<span class="id">sfinite_kernel</span> (<span class="id">k</span><span class="id"> n</span>))).<br/>
<span class="gallina-kwd">exists</span> (<span class="gallina-kwd">fun</span><span class="id"> i</span><span class="id"> =&gt;</span><span class="id"> p</span> (<span class="id">f</span><span class="id"> i</span>).<span class="id">1</span> (<span class="id">f</span><span class="id"> i</span>).<span class="id">2</span>).<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span><span class="id"> n;</span><span class="id"> have</span><span class="id"> [r</span><span class="id"> Hr]</span><span class="id"> :=</span><span class="id"> measure_uub</span> (<span class="id">p</span> (<span class="id">f</span><span class="id"> n</span>).<span class="id">1</span> (<span class="id">f</span><span class="id"> n</span>).<span class="id">2</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="gallina-kwd"> exists</span><span class="id"> r</span><span class="id"> =&gt;</span><span class="id"> x</span><span class="id"> /=;</span><span class="id"> exact:</span><span class="id"> Hr</span>.<br/>
<span class="id">move=&gt;</span><span class="id"> x</span><span class="id"> U</span><span class="id"> mU;</span><span class="id"> rewrite</span><span class="id"> /kseries</span><span class="id"> /mseries/=</span><span class="id"> /mseries/=</span>.<br/>
<span class="id">have</span><span class="id"> kE</span><span class="id"> i</span><span class="id"> :</span><span class="id"> k</span><span class="id"> i</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> \sum_</span>(<span class="id">j</span><span class="id"> &lt;oo</span>)<span class="id"> p</span><span class="id"> i</span><span class="id"> j</span><span class="id"> x</span><span class="id"> U</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> /p</span><span class="id"> /sval/=;</span><span class="id"> case:</span><span class="id"> cid</span><span class="id"> =&gt;</span><span class="id"> k_</span><span class="id"> -&gt;</span>.<br/>
<span class="id">transitivity</span> (<span class="id">\esum_</span>(<span class="id">l</span><span class="gallina-kwd"> in</span><span class="id"> [set:</span><span class="id"> nat]</span><span class="id"> `*`</span><span class="id"> [set:</span><span class="id"> nat]</span>)<span class="id"> p</span><span class="id"> l</span>.<span class="id">1</span><span class="id"> l</span>.<span class="id">2</span><span class="id"> x</span><span class="id"> U</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (_<span class="id"> :</span><span class="id"> _</span><span class="id"> `*`</span><span class="id"> _</span><span class="id"> =</span><span class="id"> setT</span><span class="id"> `*``</span> (<span class="id">fun=&gt;</span><span class="id"> setT</span>))<span class="id">;</span><span class="id"> last</span><span class="gallina-kwd"> by</span><span class="id"> apply/seteqP;</span><span class="id"> split</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> -</span>(<span class="id">@esum_esum</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span> (<span class="gallina-kwd">fun</span><span class="id"> i</span><span class="id"> j</span><span class="id"> =&gt;</span><span class="id"> p</span><span class="id"> i</span><span class="id"> j</span><span class="id"> x</span><span class="id"> U</span>))<span class="id">//</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> nneseries_esum//</span><span class="id"> -fun_true;</span><span class="id"> apply:</span><span class="id"> eq_esum</span><span class="id"> =&gt;</span><span class="id"> i</span><span class="id"> _</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> kE//</span><span class="id"> nneseries_esum</span>.<br/>
<span class="id">rewrite</span> (<span class="id">reindex_esum</span><span class="id"> [set:</span><span class="id"> nat]</span><span class="id"> _</span><span class="id"> f</span>)<span class="id">//;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span><span class="id"> :=</span><span class="id"> @bijTT</span><span class="id"> _</span><span class="id"> _</span><span class="id"> f</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> -setTT_bijective/=</span><span class="id"> -[in</span><span class="id"> X</span><span class="gallina-kwd"> in</span><span class="id"> set_bij</span><span class="id"> _</span><span class="id"> X</span><span class="id"> _</span><span class="id"> -&gt;</span><span class="id"> _]</span>(<span class="id">@setXTT</span><span class="id"> nat</span><span class="id"> nat</span>).<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> nneseries_esum//</span><span class="id"> fun_true;</span><span class="id"> exact:</span><span class="id"> eq_esum</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">Kernel_isSFinite_subdef</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> R</span> (<span class="id">kseries</span><span class="id"> k</span>)<span class="id"> sfinite_kseries</span>.<br/>
<span class="vernacular">End</span><span class="id"> sfkseries</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">mixin</span><span class="vernacular"> Record</span><span class="id"> FiniteKernel_isSubProbability</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">sprob_kernel</span><span class="id"> :</span><span class="id"> ereal_sup</span><span class="id"> [set</span><span class="id"> k</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> |</span><span class="id"> x</span><span class="gallina-kwd"> in</span><span class="id"> [set:</span><span class="id"> X]]</span><span class="id"> &lt;=</span><span class="id"> 1</span><span class="id"> }</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=sprobability_kernel</span>)<span class="id">]</span><br/>
<span class="id">HB</span>.<span class="id">structure</span><span class="vernacular"> Definition</span><span class="id"> SubProbabilityKernel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">{</span><span class="id"> k</span><span class="id"> of</span><span class="id"> @FiniteKernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> k</span><span class="id"> &amp;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">FiniteKernel_isSubProbability</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> }</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;R .-spker X ~&gt; Y&quot;</span><span class="id"> :=</span> (<span class="id">sprobability_kernel</span><span class="id"> X%type</span><span class="id"> Y</span><span class="id"> R</span>).<br/>
<br/>
<span class="id">HB</span>.<span class="id">factory</span><span class="vernacular"> Record</span><span class="id"> Kernel_isSubProbability</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> of</span><span class="id"> isKernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">sprob_kernel</span><span class="id"> :</span><span class="id"> ereal_sup</span><span class="id"> [set</span><span class="id"> k</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> |</span><span class="id"> x</span><span class="gallina-kwd"> in</span><span class="id"> [set:</span><span class="id"> X]]</span><span class="id"> &lt;=</span><span class="id"> 1</span><span class="id"> }</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">builders</span><span class="vernacular"> Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> k</span><span class="id"> of</span><span class="id"> Kernel_isSubProbability</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> finite</span><span class="id"> :</span><span class="id"> @Kernel_isFinite</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">split;</span><span class="gallina-kwd"> exists</span><span class="id"> 2%R</span><span class="id"> =&gt;</span><span class="id"> /=</span><span class="id"> ?;</span><span class="id"> rewrite</span> (<span class="id">@le_lt_trans</span><span class="id"> _</span><span class="id"> _</span><span class="id"> 1%:E</span>)<span class="id"> ?lte_fin</span><span class="id"> ?ltr1n//</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span> (<span class="id">le_trans</span><span class="id"> _</span><span class="id"> sprob_kernel</span>)<span class="id">//;</span><span class="id"> exact:</span><span class="id"> ereal_sup_ubound</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><span class="id"> finite</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@FiniteKernel_isSubProbability</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> k</span><span class="id"> sprob_kernel</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">mixin</span><span class="vernacular"> Record</span><span class="id"> SubProbability_isProbability</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">prob_kernel</span><span class="id"> :</span><span class="gallina-kwd"> forall</span><span class="id"> x,</span><span class="id"> k</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> =</span><span class="id"> 1</span><span class="id"> }</span>.<br/>
<br/>
<span class="id">#[short</span>(<span class="id">type=probability_kernel</span>)<span class="id">]</span><br/>
<span class="id">HB</span>.<span class="id">structure</span><span class="vernacular"> Definition</span><span class="id"> ProbabilityKernel</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">{</span><span class="id"> k</span><span class="id"> of</span><span class="id"> @SubProbabilityKernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> k</span><span class="id"> &amp;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">SubProbability_isProbability</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> }</span>.<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;R .-pker X ~&gt; Y&quot;</span><span class="id"> :=</span> (<span class="id">probability_kernel</span><span class="id"> X%type</span><span class="id"> Y</span><span class="id"> R</span>).<br/>
<br/>
<span class="id">HB</span>.<span class="id">factory</span><span class="vernacular"> Record</span><span class="id"> Kernel_isProbability</span><span class="id"> d</span><span class="id"> d'</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> of</span><span class="id"> isKernel</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span><span class="id"> :=</span><span class="id"> {</span><br/>
&nbsp;&nbsp;<span class="id">prob_kernel</span><span class="id"> :</span><span class="gallina-kwd"> forall</span><span class="id"> x,</span><span class="id"> k</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> =</span><span class="id"> 1</span><span class="id"> }</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">builders</span><span class="vernacular"> Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<span class="id"> k</span><span class="id"> of</span><span class="id"> Kernel_isProbability</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> sprob_kernel</span><span class="id"> :</span><span class="id"> @Kernel_isSubProbability</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> k</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd">by</span><span class="id"> split;</span><span class="id"> apply:</span><span class="id"> ub_ereal_sup</span><span class="id"> =&gt;</span><span class="id"> x</span><span class="id"> [y</span><span class="id"> _</span><span class="id"> &lt;-{x}];</span><span class="id"> rewrite</span><span class="id"> prob_kernel</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><span class="id"> sprob_kernel</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@SubProbability_isProbability</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> k</span><span class="id"> prob_kernel</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="gallina-kwd">end</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> finite_kernel_measure</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>) (<span class="id">x</span><span class="id"> :</span><span class="id"> X</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">fin_num_fun</span> (<span class="id">k</span><span class="id"> x</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> [r</span><span class="id"> k_r]</span><span class="id"> :=</span><span class="id"> measure_uub</span><span class="id"> k</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> lty_fin_num_fun;</span><span class="id"> rewrite</span> (<span class="id">@lt_trans</span><span class="id"> _</span><span class="id"> _</span><span class="id"> r%:E</span>)<span class="id"> ?ltey</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Section</span><span class="id"> measurable_prod_subset_kernel</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Implicit</span><span class="id"> Types</span><span class="id"> A</span><span class="id"> :</span><span class="id"> set</span> (<span class="id">X</span><span class="id"> *</span><span class="id"> Y</span>).<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> xsection_kernel</span>.<br/>
<span class="vernacular">Variable</span> (<span class="id">k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>) (<span class="id">D</span><span class="id"> :</span><span class="id"> set</span><span class="id"> Y</span>) (<span class="id">mD</span><span class="id"> :</span><span class="id"> measurable</span><span class="id"> D</span>).<br/>
<span class="vernacular">Let</span><span class="id"> kD</span><span class="id"> x</span><span class="id"> :=</span><span class="id"> mrestr</span> (<span class="id">k</span><span class="id"> x</span>)<span class="id"> mD</span>.<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> x</span><span class="id"> :=</span><span class="id"> Measure</span>.<span class="id">on</span> (<span class="id">kD</span><span class="id"> x</span>).<br/>
<span class="vernacular">Let</span><span class="id"> phi</span><span class="id"> A</span><span class="id"> :=</span><span class="gallina-kwd"> fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> kD</span><span class="id"> x</span> (<span class="id">xsection</span><span class="id"> A</span><span class="id"> x</span>).<br/>
<span class="vernacular">Let</span><span class="id"> XY</span><span class="id"> :=</span><span class="id"> [set</span><span class="id"> A</span><span class="id"> |</span><span class="id"> measurable</span><span class="id"> A</span><span class="id"> /\</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">phi</span><span class="id"> A</span>)<span class="id">]</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> phiM</span> (<span class="id">A</span><span class="id"> :</span><span class="id"> set</span><span class="id"> X</span>)<span class="id"> B</span><span class="id"> :</span><span class="id"> phi</span> (<span class="id">A</span><span class="id"> `*`</span><span class="id"> B</span>)<span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> kD</span><span class="id"> x</span><span class="id"> B</span><span class="id"> *</span> (<span class="id">\1_A</span><span class="id"> x</span>)<span class="id">%:E</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">rewrite</span><span class="id"> funeqE</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> rewrite</span><span class="id"> indicE</span><span class="id"> /phi/=</span>.<br/>
<span class="id">have</span><span class="id"> [xA|xA]</span><span class="id"> :=</span><span class="id"> boolP</span> (<span class="id">x</span><span class="id"> \in</span><span class="id"> A</span>)<span class="id">;</span><span class="id"> first</span><span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> mule1</span><span class="id"> in_xsectionX</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> mule0</span><span class="id"> notin_xsectionX//</span><span class="id"> set0I</span><span class="id"> measure0</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_prod_subset_xsection_kernel</span><span class="id"> :</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">forall</span><span class="id"> x,</span><span class="gallina-kwd"> exists</span><span class="id"> M,</span><span class="gallina-kwd"> forall</span><span class="id"> X,</span><span class="id"> measurable</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> kD</span><span class="id"> x</span><span class="id"> X</span><span class="id"> &lt;</span><span class="id"> M%:E</span>)<span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable</span><span class="id"> `&lt;=`</span><span class="id"> XY</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> kD_ub;</span><span class="id"> rewrite</span><span class="id"> measurable_prod_measurableType</span>.<br/>
<span class="id">set</span><span class="id"> C</span><span class="id"> :=</span><span class="id"> [set</span><span class="id"> A</span><span class="id"> `*`</span><span class="id"> B</span><span class="id"> |</span><span class="id"> A</span><span class="gallina-kwd"> in</span><span class="id"> measurable</span><span class="id"> &amp;</span><span class="id"> B</span><span class="gallina-kwd"> in</span><span class="id"> measurable]</span>.<br/>
<span class="id">have</span><span class="id"> CI</span><span class="id"> :</span><span class="id"> setI_closed</span><span class="id"> C</span>.<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span><span class="id"> _</span><span class="id"> _</span><span class="id"> [X1</span><span class="id"> mX1</span><span class="id"> [X2</span><span class="id"> mX2</span><span class="id"> &lt;-]]</span><span class="id"> [Y1</span><span class="id"> mY1</span><span class="id"> [Y2</span><span class="id"> mY2</span><span class="id"> &lt;-]]</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">X1</span><span class="id"> `&amp;`</span><span class="id"> Y1</span>)<span class="id">;</span><span class="id"> first</span><span class="id"> exact:</span><span class="id"> measurableI</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="gallina-kwd"> exists</span> (<span class="id">X2</span><span class="id"> `&amp;`</span><span class="id"> Y2</span>)<span class="id">;</span><span class="id"> [exact:</span><span class="id"> measurableI|rewrite</span><span class="id"> setXI]</span>.<br/>
<span class="id">have</span><span class="id"> CT</span><span class="id"> :</span><span class="id"> C</span><span class="id"> setT</span><span class="gallina-kwd"> by</span><span class="gallina-kwd"> exists</span><span class="id"> setT</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="gallina-kwd"> exists</span><span class="id"> setT</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> rewrite</span><span class="id"> setXTT</span>.<br/>
<span class="id">have</span><span class="id"> CXY</span><span class="id"> :</span><span class="id"> C</span><span class="id"> `&lt;=`</span><span class="id"> XY</span>.<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span><span class="id"> _</span><span class="id"> [A</span><span class="id"> mA</span><span class="id"> [B</span><span class="id"> mB</span><span class="id"> &lt;-]];</span><span class="id"> split;</span><span class="id"> first</span><span class="id"> exact:</span><span class="id"> measurableX</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> phiM</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span><span class="id"> emeasurable_funM</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> first</span><span class="id"> exact/measurable_kernel/measurableI</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/measurable_EFinP;</span><span class="id"> rewrite</span> (_<span class="id"> :</span><span class="id"> \1_</span><span class="id"> _</span><span class="id"> =</span><span class="id"> mindic</span><span class="id"> R</span><span class="id"> mA</span>).<br/>
<span class="id">suff</span><span class="id"> lsystemB</span><span class="id"> :</span><span class="id"> lambda_system</span><span class="id"> setT</span><span class="id"> XY</span><span class="gallina-kwd"> by</span><span class="id"> exact:</span><span class="id"> lambda_system_subset</span>.<br/>
<span class="id">split</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> [exact:</span><span class="id"> CXY|</span><span class="id"> |exact:</span><span class="id"> xsection_ndseq_closed]</span>.<br/>
<span class="id">move=&gt;</span><span class="id"> A</span><span class="id"> B</span><span class="id"> BA</span><span class="id"> [mA</span><span class="id"> mphiA]</span><span class="id"> [mB</span><span class="id"> mphiB];</span><span class="id"> split;</span><span class="id"> first</span><span class="id"> exact:</span><span class="id"> measurableD</span>.<br/>
<span class="id">suff</span><span class="id"> :</span><span class="id"> phi</span> (<span class="id">A</span><span class="id"> `\`</span><span class="id"> B</span>)<span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> phi</span><span class="id"> A</span><span class="id"> x</span><span class="id"> -</span><span class="id"> phi</span><span class="id"> B</span><span class="id"> x</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> -&gt;;</span><span class="id"> exact:</span><span class="id"> emeasurable_funB</span>.<br/>
<span class="id">rewrite</span><span class="id"> funeqE</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> rewrite</span><span class="id"> /phi/=</span><span class="id"> xsectionD//</span><span class="id"> measureD</span>.<br/>
<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> setIidr//;</span><span class="id"> exact:</span><span class="id"> le_xsection</span>.<br/>
<span class="id">-</span><span class="id"> exact:</span><span class="id"> measurable_xsection</span>.<br/>
<span class="id">-</span><span class="id"> exact:</span><span class="id"> measurable_xsection</span>.<br/>
<span class="id">-</span><span class="id"> have</span><span class="id"> [M</span><span class="id"> kM]</span><span class="id"> :=</span><span class="id"> kD_ub</span><span class="id"> x</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">lt_le_trans</span> (<span class="id">kM</span> (<span class="id">xsection</span><span class="id"> A</span><span class="id"> x</span>)<span class="id"> _</span>))<span class="id"> ?leey//</span>.<br/>
&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> measurable_xsection</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> xsection_kernel</span>.<br/>
<br/>
<span class="vernacular">End</span><span class="id"> measurable_prod_subset_kernel</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> measurable_fun_xsection_finite_kernel</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<span class="vernacular">Implicit</span><span class="id"> Types</span><span class="id"> A</span><span class="id"> :</span><span class="id"> set</span> (<span class="id">X</span><span class="id"> *</span><span class="id"> Y</span>).<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> phi</span><span class="id"> A</span><span class="id"> :=</span><span class="gallina-kwd"> fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> k</span><span class="id"> x</span> (<span class="id">xsection</span><span class="id"> A</span><span class="id"> x</span>).<br/>
<span class="vernacular">Let</span><span class="id"> XY</span><span class="id"> :=</span><span class="id"> [set</span><span class="id"> A</span><span class="id"> |</span><span class="id"> measurable</span><span class="id"> A</span><span class="id"> /\</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">phi</span><span class="id"> A</span>)<span class="id">]</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_xsection_finite_kernel</span><span class="id"> A</span><span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">A</span><span class="id"> \in</span><span class="id"> measurable</span><span class="id"> -&gt;</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">phi</span><span class="id"> A</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move:</span><span class="id"> A;</span><span class="id"> suff</span><span class="id"> :</span><span class="id"> measurable</span><span class="id"> `&lt;=`</span><span class="id"> XY</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> +</span><span class="id"> A;</span><span class="id"> rewrite</span><span class="id"> inE</span><span class="id"> =&gt;</span><span class="id"> /[apply]</span><span class="id"> -[]</span>.<br/>
<span class="id">move=&gt;</span><span class="id"> /=</span><span class="id"> A</span><span class="id"> mA;</span><span class="id"> rewrite</span><span class="id"> /XY/=;</span><span class="id"> split</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> rewrite</span> (_<span class="id"> :</span><span class="id"> phi</span><span class="id"> _</span><span class="id"> =</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> mrestr</span> (<span class="id">k</span><span class="id"> x</span>)<span class="id"> measurableT</span> (<span class="id">xsection</span><span class="id"> A</span><span class="id"> x</span>)))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> x//=;</span><span class="id"> rewrite</span><span class="id"> /mrestr</span><span class="id"> setIT</span>.<br/>
<span class="id">apply</span><span class="id"> measurable_prod_subset_xsection_kernel</span><span class="id"> =&gt;</span><span class="id"> //</span><span class="id"> x</span>.<br/>
<span class="id">have</span><span class="id"> [r</span><span class="id"> hr]</span><span class="id"> :=</span><span class="id"> measure_uub</span><span class="id"> k;</span><span class="gallina-kwd"> exists</span><span class="id"> r</span><span class="id"> =&gt;</span><span class="id"> B</span><span class="id"> mB</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span> (<span class="id">le_lt_trans</span><span class="id"> _</span> (<span class="id">hr</span><span class="id"> x</span>))<span class="id"> //</span><span class="id"> /mrestr</span><span class="id"> /=</span><span class="id"> setIT</span><span class="id"> le_measure//</span><span class="id"> inE</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> measurable_fun_xsection_finite_kernel</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> measurable_fun_integral_finite_sfinite</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R</span>.<br/>
<br/>
<span class="vernacular">Import</span><span class="id"> HBNNSimple</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_xsection_integral</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">l</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k_</span><span class="id"> :</span><span class="id"> {nnsfun</span> (<span class="id">X</span><span class="id"> *</span><span class="id"> Y</span>)<span class="id"> &gt;-&gt;</span><span class="id"> R}^nat</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ndk_</span><span class="id"> :</span><span class="id"> nondecreasing_seq</span> (<span class="id">k_</span><span class="id"> :</span> (<span class="id">X</span><span class="id"> *</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> R</span>)<span class="id">^nat</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k_k</span><span class="id"> :</span><span class="gallina-kwd"> forall</span><span class="id"> z,</span> (<span class="id">k_</span><span class="id"> n</span><span class="id"> z</span>)<span class="id">%:E</span><span class="id"> @[n</span><span class="id"> --&gt;</span><span class="id"> \oo]</span><span class="id"> --&gt;</span><span class="id"> k</span><span class="id"> z</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span><span class="id"> n</span><span class="id"> r,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> l</span><span class="id"> x</span> (<span class="id">xsection</span> (<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="id"> x</span>)))<span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> \int[l</span><span class="id"> x]_y</span><span class="id"> k</span> (<span class="id">x,</span><span class="id"> y</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> h</span>.<br/>
<span class="id">rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> limn_esup</span> (<span class="gallina-kwd">fun</span><span class="id"> n</span><span class="id"> =&gt;</span><span class="id"> \int[l</span><span class="id"> x]_y</span> (<span class="id">k_</span><span class="id"> n</span> (<span class="id">x,</span><span class="id"> y</span>))<span class="id">%:E</span>)))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/funext</span><span class="id"> =&gt;</span><span class="id"> x</span>.<br/>
&nbsp;&nbsp;<span class="id">transitivity</span> (<span class="id">lim</span> (<span class="id">\int[l</span><span class="id"> x]_y</span> (<span class="id">k_</span><span class="id"> n</span> (<span class="id">x,</span><span class="id"> y</span>))<span class="id">%:E</span><span class="id"> @[n</span><span class="id"> --&gt;</span><span class="id"> \oo]</span>))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> is_cvg_limn_esupE//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply:</span><span class="id"> ereal_nondecreasing_is_cvgn</span><span class="id"> =&gt;</span><span class="id"> m</span><span class="id"> n</span><span class="id"> mn</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply:</span><span class="id"> ge0_le_integral</span><span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">-</span><span class="id"> exact/measurable_EFinP/measurableT_comp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">-</span><span class="id"> exact/measurable_EFinP/measurableT_comp</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin;</span><span class="id"> exact/lefP/ndk_</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> -monotone_convergence//</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> apply:</span><span class="id"> eq_integral</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> apply/esym/cvg_lim</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> exact:</span><span class="id"> k_k</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> n;</span><span class="id"> exact/measurable_EFinP/measurableT_comp</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> n</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> y</span><span class="id"> _</span><span class="id"> m</span><span class="id"> n</span><span class="id"> mn;</span><span class="id"> rewrite</span><span class="id"> lee_fin;</span><span class="id"> exact/lefP/ndk_</span>.<br/>
<span class="id">apply:</span><span class="id"> measurable_fun_limn_esup</span><span class="id"> =&gt;</span><span class="id"> n</span>.<br/>
<span class="id">rewrite</span><span class="id"> [X</span><span class="gallina-kwd"> in</span><span class="id"> measurable_fun</span><span class="id"> _</span><span class="id"> X]</span>(_<span class="id"> :</span><span class="id"> _</span><span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> \int[l</span><span class="id"> x]_y</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">\sum_</span>(<span class="id">r</span><span class="id"> \in</span><span class="id"> range</span> (<span class="id">k_</span><span class="id"> n</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">r</span><span class="id"> *</span><span class="id"> \1_</span>(<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>) (<span class="id">x,</span><span class="id"> y</span>))<span class="id">%:E</span>))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> apply:</span><span class="id"> eq_integral</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> fimfunE</span>.<br/>
<span class="id">rewrite</span><span class="id"> [X</span><span class="gallina-kwd"> in</span><span class="id"> measurable_fun</span><span class="id"> _</span><span class="id"> X]</span>(_<span class="id"> :</span><span class="id"> _</span><span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> \sum_</span>(<span class="id">r</span><span class="id"> \in</span><span class="id"> range</span> (<span class="id">k_</span><span class="id"> n</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">\int[l</span><span class="id"> x]_y</span> (<span class="id">r</span><span class="id"> *</span><span class="id"> \1_</span>(<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>) (<span class="id">x,</span><span class="id"> y</span>))<span class="id">%:E</span>)))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/funext</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> rewrite</span><span class="id"> -ge0_integral_fsum//</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> apply:</span><span class="id"> eq_integral</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> -fsumEFin</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="id"> move=&gt;</span><span class="id"> r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">apply/measurable_EFinP/measurableT_comp</span><span class="id"> =&gt;</span><span class="id"> [//|]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact/measurableT_comp</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> m</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> nnfun_muleindic_ge0</span>.<br/>
<span class="id">apply:</span><span class="id"> emeasurable_fun_fsum</span><span class="id"> =&gt;</span><span class="id"> //</span><span class="id"> r</span>.<br/>
<span class="id">rewrite</span><span class="id"> [X</span><span class="gallina-kwd"> in</span><span class="id"> measurable_fun</span><span class="id"> _</span><span class="id"> X]</span>(_<span class="id"> :</span><span class="id"> _</span><span class="id"> =</span><span class="gallina-kwd"> fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> r%:E</span><span class="id"> *</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">\int[l</span><span class="id"> x]_y</span> (<span class="id">\1_</span>(<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>) (<span class="id">x,</span><span class="id"> y</span>))<span class="id">%:E</span>)<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/funext</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> under</span><span class="id"> eq_integral</span><span class="id"> do</span><span class="id"> rewrite</span><span class="id"> EFinM</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span><span class="id"> [r0|r0]</span><span class="id"> :=</span><span class="id"> leP</span><span class="id"> 0%R</span><span class="id"> r</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> ge0_integralZl//;</span><span class="id"> last</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> *;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact/measurable_EFinP/measurableT_comp</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> integral0_eq;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> preimage_nnfun0//</span><span class="id"> indic0</span><span class="id"> mule0</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> integral0_eq</span><span class="id"> ?mule0//</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> preimage_nnfun0//</span><span class="id"> indic0</span>.<br/>
<span class="id">apply/measurable_funeM</span>.<br/>
<span class="id">rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> l</span><span class="id"> x</span> (<span class="id">xsection</span> (<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="id"> x</span>))).<br/>
&nbsp;&nbsp;<span class="id">exact/h</span>.<br/>
<span class="id">apply/funext</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> rewrite</span><span class="id"> integral_indic//;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span><span class="id"> xsection</span> (<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="id"> x</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> measurable_xsection</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> /xsection;</span><span class="id"> apply/seteqP;</span><span class="id"> split=&gt;</span><span class="id"> y/=</span><span class="id"> /[!inE]</span>.<br/>
<span class="id">congr</span> (<span class="id">l</span><span class="id"> x</span><span class="id"> _</span>)<span class="id">;</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> y1/=;</span><span class="id"> rewrite</span><span class="id"> /xsection/=</span><span class="id"> inE</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply/propext;</span><span class="id"> tauto</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_integral_finite_kernel</span> (<span class="id">l</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k0</span><span class="id"> :</span><span class="gallina-kwd"> forall</span><span class="id"> z,</span><span class="id"> 0</span><span class="id"> &lt;=</span><span class="id"> k</span><span class="id"> z</span>) (<span class="id">mk</span><span class="id"> :</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span><span class="id"> k</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> \int[l</span><span class="id"> x]_y</span><span class="id"> k</span> (<span class="id">x,</span><span class="id"> y</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> [k_</span><span class="id"> [ndk_</span><span class="id"> k_k]]</span><span class="id"> :=</span><span class="id"> approximation</span><span class="id"> measurableT</span><span class="id"> mk</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> _</span><span class="id"> =&gt;</span><span class="id"> k0</span><span class="id"> x</span>).<br/>
<span class="id">apply:</span> (<span class="id">measurable_fun_xsection_integral</span><span class="id"> ndk_</span> (<span class="id">k_k</span><span class="id"> ^~</span><span class="id"> Logic</span>.<span class="id">I</span>))<span class="id"> =&gt;</span><span class="id"> n</span><span class="id"> r</span>.<br/>
<span class="id">have</span><span class="id"> [l_</span><span class="id"> hl_]</span><span class="id"> :=</span><span class="id"> measure_uub</span><span class="id"> l</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> measurable_fun_xsection_finite_kernel</span><span class="id"> =&gt;</span><span class="id"> //</span><span class="id"> /[!inE]</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_integral_sfinite_kernel</span> (<span class="id">l</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k0</span><span class="id"> :</span><span class="gallina-kwd"> forall</span><span class="id"> t,</span><span class="id"> 0</span><span class="id"> &lt;=</span><span class="id"> k</span><span class="id"> t</span>) (<span class="id">mk</span><span class="id"> :</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span><span class="id"> k</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> \int[l</span><span class="id"> x]_y</span><span class="id"> k</span> (<span class="id">x,</span><span class="id"> y</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> [k_</span><span class="id"> [ndk_</span><span class="id"> k_k]]</span><span class="id"> :=</span><span class="id"> approximation</span><span class="id"> measurableT</span><span class="id"> mk</span> (<span class="gallina-kwd">fun</span><span class="id"> xy</span><span class="id"> _</span><span class="id"> =&gt;</span><span class="id"> k0</span><span class="id"> xy</span>).<br/>
<span class="id">apply:</span> (<span class="id">measurable_fun_xsection_integral</span><span class="id"> ndk_</span> (<span class="id">k_k</span><span class="id"> ^~</span><span class="id"> Logic</span>.<span class="id">I</span>))<span class="id"> =&gt;</span><span class="id"> n</span><span class="id"> r</span>.<br/>
<span class="id">have</span><span class="id"> [l_</span><span class="id"> hl_]</span><span class="id"> :=</span><span class="id"> sfinite_kernel</span><span class="id"> l</span>.<br/>
<span class="id">rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">mseries</span> (<span class="id">l_</span><span class="id"> ^~</span><span class="id"> x</span>)<span class="id"> 0</span> (<span class="id">xsection</span> (<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="id"> x</span>)))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> rewrite</span><span class="id"> hl_//;</span><span class="id"> exact/measurable_xsection</span>.<br/>
<span class="id">apply:</span><span class="id"> ge0_emeasurable_fun_sum</span><span class="id"> =&gt;</span><span class="id"> //</span><span class="id"> m</span><span class="id"> _</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> measurable_fun_xsection_finite_kernel</span><span class="id"> =&gt;</span><span class="id"> //</span><span class="id"> /[!inE]</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> measurable_fun_integral_finite_sfinite</span>.<br/>
<span class="vernacular">Arguments</span><span class="id"> measurable_fun_xsection_integral</span><span class="id"> {_</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _}</span><span class="id"> k</span><span class="id"> l</span>.<br/>
<span class="vernacular">Arguments</span><span class="id"> measurable_fun_integral_finite_kernel</span><span class="id"> {_</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _}</span><span class="id"> k</span><span class="id"> l</span>.<br/>
<span class="vernacular">Arguments</span><span class="id"> measurable_fun_integral_sfinite_kernel</span><span class="id"> {_</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _}</span><span class="id"> k</span><span class="id"> l</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> kdirac</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> f</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> Y</span>.<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> kdirac</span> (<span class="id">mf</span><span class="id"> :</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span><span class="id"> f</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">:</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> [the</span><span class="id"> measure</span><span class="id"> _</span><span class="id"> _</span><span class="id"> of</span><span class="id"> dirac</span> (<span class="id">f</span><span class="id"> x</span>)<span class="id">]</span>.<br/>
<br/>
<span class="vernacular">Hypothesis</span><span class="id"> mf</span><span class="id"> :</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span><span class="id"> f</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> measurable_fun_kdirac</span><span class="id"> U</span><span class="id"> :</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">kdirac</span><span class="id"> mf</span><span class="id"> ^~</span><span class="id"> U</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> mU;</span><span class="id"> apply/measurable_EFinP</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span><span class="id"> mindic</span><span class="id"> R</span><span class="id"> mU</span><span class="id"> \o</span><span class="id"> f</span>)<span class="id">//;</span><span class="id"> exact/measurableT_comp</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><span class="id"> isKernel</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span> (<span class="id">kdirac</span><span class="id"> mf</span>)<br/>
&nbsp;&nbsp;<span class="id">measurable_fun_kdirac</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> kdirac_prob</span><span class="id"> x</span><span class="id"> :</span><span class="id"> kdirac</span><span class="id"> mf</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> =</span><span class="id"> 1</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> /kdirac/=</span><span class="id"> diracT</span>. Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><span class="id"> Kernel_isProbability</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><br/>
&nbsp;&nbsp;(<span class="id">kdirac</span><span class="id"> mf</span>)<span class="id"> kdirac_prob</span>.<br/>
<br/>
<span class="vernacular">End</span><span class="id"> kdirac</span>.<br/>
<span class="vernacular">Arguments</span><span class="id"> kdirac</span><span class="id"> {d</span><span class="id"> d'</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span><span class="id"> f}</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> kprobability</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> P</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> pprobability</span><span class="id"> Y</span><span class="id"> R</span>.<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> kprobability</span> (<span class="id">mP</span><span class="id"> :</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span><span class="id"> P</span>)<br/>
&nbsp;&nbsp;<span class="id">:</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span><span class="id"> :=</span><span class="id"> P</span>.<br/>
<br/>
<span class="vernacular">Hypothesis</span><span class="id"> mP</span><span class="id"> :</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span><span class="id"> P</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> measurable_fun_kprobability</span><span class="id"> U</span><span class="id"> :</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">kprobability</span><span class="id"> mP</span><span class="id"> ^~</span><span class="id"> U</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> mU</span>.<br/>
<span class="id">apply:</span> (<span class="id">measurability</span> (<span class="id">ErealGenInftyO</span>.<span class="id">measurableE</span><span class="id"> R</span>))<span class="id"> =&gt;</span><span class="id"> _</span><span class="id"> /=</span><span class="id"> -[_</span><span class="id"> [r</span><span class="id"> -&gt;]</span><span class="id"> &lt;-]</span>.<br/>
<span class="id">rewrite</span><span class="id"> setTI</span><span class="id"> preimage_itv_infty_o</span><span class="id"> -/</span>(<span class="id">P</span><span class="id"> @^-1`</span><span class="id"> mset</span><span class="id"> U</span><span class="id"> r</span>).<br/>
<span class="id">have</span><span class="id"> [r0|r0]</span><span class="id"> :=</span><span class="id"> leP</span><span class="id"> 0%R</span><span class="id"> r;</span><span class="id"> last</span><span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> lt0_mset//</span><span class="id"> preimage_set0</span>.<br/>
<span class="id">have</span><span class="id"> [r1|r1]</span><span class="id"> :=</span><span class="id"> leP</span><span class="id"> r</span><span class="id"> 1%R;</span><span class="id"> last</span><span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> gt1_mset//</span><span class="id"> preimage_setT</span>.<br/>
<span class="id">move:</span><span class="id"> mP</span><span class="id"> =&gt;</span><span class="id"> /</span>(_<span class="id"> measurableT</span> (<span class="id">mset</span><span class="id"> U</span><span class="id"> r</span>))<span class="id">;</span><span class="id"> rewrite</span><span class="id"> setTI;</span><span class="id"> apply</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> sub_sigma_algebra;</span><span class="gallina-kwd"> exists</span><span class="id"> r</span><span class="id"> =&gt;</span><span class="id"> /=;</span><span class="id"> [rewrite</span><span class="id"> in_itv/=</span><span class="id"> r0|exists</span><span class="id"> U]</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@isKernel</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span> (<span class="id">kprobability</span><span class="id"> mP</span>)<span class="id"> measurable_fun_kprobability</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> kprobability_prob</span><span class="id"> x</span><span class="id"> :</span><span class="id"> kprobability</span><span class="id"> mP</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> =</span><span class="id"> 1</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> /kprobability/=</span><span class="id"> probability_setT</span>. Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@Kernel_isProbability</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Y</span><span class="id"> R</span> (<span class="id">kprobability</span><span class="id"> mP</span>)<span class="id"> kprobability_prob</span>.<br/>
<br/>
<span class="vernacular">End</span><span class="id"> kprobability</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> kadd</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variables</span><span class="id"> k1</span><span class="id"> k2</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> kadd</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> [the</span><span class="id"> measure</span><span class="id"> _</span><span class="id"> _</span><span class="id"> of</span><span class="id"> measure_add</span> (<span class="id">k1</span><span class="id"> x</span>) (<span class="id">k2</span><span class="id"> x</span>)<span class="id">]</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> measurable_fun_kadd</span><span class="id"> U</span><span class="id"> :</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">kadd</span><span class="id"> ^~</span><span class="id"> U</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> mU;</span><span class="id"> rewrite</span><span class="id"> /kadd</span>.<br/>
<span class="id">rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> _</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> k1</span><span class="id"> x</span><span class="id"> U</span><span class="id"> +</span><span class="id"> k2</span><span class="id"> x</span><span class="id"> U</span>))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> rewrite</span><span class="id"> -measure_addE</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> emeasurable_funD;</span><span class="id"> exact/measurable_kernel</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">@isKernel</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> kadd</span><span class="id"> measurable_fun_kadd</span>.<br/>
<span class="vernacular">End</span><span class="id"> kadd</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> sfkadd</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variables</span><span class="id"> k1</span><span class="id"> k2</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> sfinite_kadd</span><span class="id"> :</span><span class="gallina-kwd"> exists2</span><span class="id"> k_</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-ker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span>)<span class="id">^nat,</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> n,</span><span class="id"> measure_fam_uub</span> (<span class="id">k_</span><span class="id"> n</span>)<span class="id"> &amp;</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">kadd</span><span class="id"> k1</span><span class="id"> k2</span><span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> mseries</span> (<span class="id">k_</span><span class="id"> ^~</span><span class="id"> x</span>)<span class="id"> 0</span><span class="id"> U</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> [f1</span><span class="id"> hk1]</span><span class="id"> :=</span><span class="id"> sfinite_kernel</span><span class="id"> k1;</span><span class="id"> have</span><span class="id"> [f2</span><span class="id"> hk2]</span><span class="id"> :=</span><span class="id"> sfinite_kernel</span><span class="id"> k2</span>.<br/>
<span class="gallina-kwd">exists</span> (<span class="gallina-kwd">fun</span><span class="id"> n</span><span class="id"> =&gt;</span><span class="id"> [the</span><span class="id"> _</span>.<span class="id">-ker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span><span class="id"> of</span><span class="id"> kadd</span> (<span class="id">f1</span><span class="id"> n</span>) (<span class="id">f2</span><span class="id"> n</span>)<span class="id">]</span>).<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span><span class="id"> n</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span><span class="id"> [r1</span><span class="id"> f1r1]</span><span class="id"> :=</span><span class="id"> measure_uub</span> (<span class="id">f1</span><span class="id"> n</span>).<br/>
&nbsp;&nbsp;<span class="id">have</span><span class="id"> [r2</span><span class="id"> f2r2]</span><span class="id"> :=</span><span class="id"> measure_uub</span> (<span class="id">f2</span><span class="id"> n</span>).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="id">r1</span><span class="id"> +</span><span class="id"> r2</span>)<span class="id">%R</span><span class="id"> =&gt;</span><span class="id"> x/=</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> /msum</span><span class="id"> !big_ord_recr/=</span><span class="id"> big_ord0</span><span class="id"> add0e</span><span class="id"> EFinD</span><span class="id"> lteD</span>.<br/>
<span class="id">move=&gt;</span><span class="id"> x</span><span class="id"> U</span><span class="id"> mU</span>.<br/>
<span class="id">rewrite</span><span class="id"> /kadd/=</span><span class="id"> -/</span>(<span class="id">measure_add</span> (<span class="id">k1</span><span class="id"> x</span>) (<span class="id">k2</span><span class="id"> x</span>))<span class="id"> measure_addE</span><span class="id"> hk1//=</span><span class="id"> hk2//=</span>.<br/>
<span class="id">rewrite</span><span class="id"> /mseries</span><span class="id"> -nneseriesD//;</span><span class="id"> apply:</span><span class="id"> eq_eseriesr</span><span class="id"> =&gt;</span><span class="id"> n</span><span class="id"> _</span><span class="id"> /=</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> -/</span>(<span class="id">measure_add</span> (<span class="id">f1</span><span class="id"> n</span><span class="id"> x</span>) (<span class="id">f2</span><span class="id"> n</span><span class="id"> x</span>))<span class="id"> measure_addE</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> t</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">Kernel_isSFinite_subdef</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> R</span> (<span class="id">kadd</span><span class="id"> k1</span><span class="id"> k2</span>)<span class="id"> sfinite_kadd</span>.<br/>
<span class="vernacular">End</span><span class="id"> sfkadd</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> fkadd</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variables</span><span class="id"> k1</span><span class="id"> k2</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> kadd_finite_uub</span><span class="id"> :</span><span class="id"> measure_fam_uub</span> (<span class="id">kadd</span><span class="id"> k1</span><span class="id"> k2</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> [f1</span><span class="id"> hk1]</span><span class="id"> :=</span><span class="id"> measure_uub</span><span class="id"> k1;</span><span class="id"> have</span><span class="id"> [f2</span><span class="id"> hk2]</span><span class="id"> :=</span><span class="id"> measure_uub</span><span class="id"> k2</span>.<br/>
<span class="gallina-kwd">exists</span> (<span class="id">f1</span><span class="id"> +</span><span class="id"> f2</span>)<span class="id">%R</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> rewrite</span><span class="id"> /kadd</span><span class="id"> /=</span>.<br/>
<span class="id">rewrite</span><span class="id"> -/</span>(<span class="id">measure_add</span> (<span class="id">k1</span><span class="id"> x</span>) (<span class="id">k2</span><span class="id"> x</span>)).<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> measure_addE</span><span class="id"> EFinD;</span><span class="id"> exact:</span><span class="id"> lteD</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> t</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">Kernel_isFinite</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> R</span> (<span class="id">kadd</span><span class="id"> k1</span><span class="id"> k2</span>)<span class="id"> kadd_finite_uub</span>.<br/>
<span class="vernacular">End</span><span class="id"> fkadd</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> knormalize</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> f</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> knormalize</span> (<span class="id">P</span><span class="id"> :</span><span class="id"> probability</span><span class="id"> Y</span><span class="id"> R</span>)<span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> mnormalize</span> (<span class="id">f</span><span class="id"> x</span>)<span class="id"> P</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> measurable_knormalize</span> (<span class="id">P</span><span class="id"> :</span><span class="id"> probability</span><span class="id"> Y</span><span class="id"> R</span>)<span class="id"> U</span><span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">knormalize</span><span class="id"> P</span><span class="id"> ^~</span><span class="id"> U</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> mU;</span><span class="id"> rewrite</span><span class="id"> /knormalize/=</span><span class="id"> /mnormalize</span><span class="id"> /=</span>.<br/>
<span class="id">rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> _</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">if</span><span class="id"> f</span><span class="id"> x</span><span class="id"> setT</span><span class="id"> ==</span><span class="id"> 0</span><span class="gallina-kwd"> then</span><span class="id"> P</span><span class="id"> U</span><span class="gallina-kwd"> else</span><span class="gallina-kwd"> if</span><span class="id"> f</span><span class="id"> x</span><span class="id"> setT</span><span class="id"> ==</span><span class="id"> +oo</span><span class="gallina-kwd"> then</span><span class="id"> P</span><span class="id"> U</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">else</span><span class="id"> f</span><span class="id"> x</span><span class="id"> U</span><span class="id"> *</span> (<span class="id">fine</span> (<span class="id">f</span><span class="id"> x</span><span class="id"> setT</span>))<span class="id">^-1%:E</span>))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/funext</span><span class="id"> =&gt;</span><span class="id"> x;</span><span class="id"> case:</span><span class="id"> ifPn</span><span class="id"> =&gt;</span><span class="id"> [/orP[-&gt;//|-&gt;]|];</span><span class="id"> first</span><span class="gallina-kwd"> by</span><span class="id"> case:</span><span class="id"> ifPn</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> negb_or=&gt;</span><span class="id"> /andP[/negbTE</span><span class="id"> -&gt;</span><span class="id"> /negbTE</span><span class="id"> -&gt;]</span>.<br/>
<span class="id">apply:</span><span class="id"> measurable_fun_if</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> [exact:</span><span class="id"> kernel_measurable_fun_eq_cst|]</span>.<br/>
<span class="id">apply:</span><span class="id"> measurable_fun_if</span><span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
<span class="id">-</span><span class="id"> rewrite</span><span class="id"> setTI</span><span class="id"> [X</span><span class="gallina-kwd"> in</span><span class="id"> measurable</span><span class="id"> X]</span>(_<span class="id"> :</span><span class="id"> _</span><span class="id"> =</span><span class="id"> [set</span><span class="id"> t</span><span class="id"> |</span><span class="id"> f</span><span class="id"> t</span><span class="id"> setT</span><span class="id"> !=</span><span class="id"> 0]</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> kernel_measurable_neq_cst</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/seteqP;</span><span class="id"> split</span><span class="id"> =&gt;</span><span class="id"> [x</span><span class="id"> /negbT//|x</span><span class="id"> /negbTE]</span>.<br/>
<span class="id">-</span><span class="id"> apply:</span> (<span class="id">@measurable_funS</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> setT</span>)<span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> kernel_measurable_fun_eq_cst</span>.<br/>
<span class="id">-</span><span class="id"> apply:</span><span class="id"> emeasurable_funM</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> measurable_funS</span> (<span class="id">measurable_kernel</span><span class="id"> f</span><span class="id"> U</span><span class="id"> mU</span>).<br/>
&nbsp;&nbsp;<span class="id">apply/measurable_EFinP</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> (<span class="id">@measurable_comp</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> [set</span><span class="id"> r</span><span class="id"> :</span><span class="id"> R</span><span class="id"> |</span><span class="id"> r</span><span class="id"> !=</span><span class="id"> 0%R]</span>)<span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span><span class="id"> exact:</span><span class="id"> open_measurable</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span><span class="id"> move=&gt;</span><span class="id"> /=</span><span class="id"> r</span><span class="id"> [t]</span><span class="id"> []</span><span class="id"> [_</span><span class="id"> ft0]</span><span class="id"> ftoo</span><span class="id"> ftr;</span><span class="id"> apply/eqP</span><span class="id"> =&gt;</span><span class="id"> r0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move:</span> (<span class="id">ftr</span>)<span class="id">;</span><span class="id"> rewrite</span><span class="id"> r0</span><span class="id"> =&gt;</span><span class="id"> /eqP;</span><span class="id"> rewrite</span><span class="id"> fine_eq0</span><span class="id"> ?ft0//</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> ge0_fin_numE//</span><span class="id"> lt_neqAle</span><span class="id"> leey</span><span class="id"> ftoo</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span><span class="id"> apply:</span><span class="id"> open_continuous_measurable_fun</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> apply/in_setP</span><span class="id"> =&gt;</span><span class="id"> x</span><span class="id"> /=</span><span class="id"> x0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> inv_continuous</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span><span class="id"> apply:</span><span class="id"> measurableT_comp</span><span class="id"> =&gt;</span><span class="id"> //=</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> have</span><span class="id"> :=</span><span class="id"> measurable_kernel</span><span class="id"> f</span><span class="id"> _</span><span class="id"> measurableT;</span><span class="id"> exact:</span><span class="id"> measurable_funS</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span> (<span class="id">P</span><span class="id"> :</span><span class="id"> probability</span><span class="id"> Y</span><span class="id"> R</span>)<span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">isKernel</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> R</span> (<span class="id">knormalize</span><span class="id"> P</span>) (<span class="id">measurable_knormalize</span><span class="id"> P</span>).<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> knormalize1</span> (<span class="id">P</span><span class="id"> :</span><span class="id"> probability</span><span class="id"> Y</span><span class="id"> R</span>)<span class="id"> x</span><span class="id"> :</span><span class="id"> knormalize</span><span class="id"> P</span><span class="id"> x</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> =</span><span class="id"> 1</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> /knormalize/=</span><span class="id"> probability_setT</span>. Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span> (<span class="id">P</span><span class="id"> :</span><span class="id"> probability</span><span class="id"> Y</span><span class="id"> R</span>)<span class="id">:=</span><br/>
&nbsp;&nbsp;<span class="id">@Kernel_isProbability</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span> (<span class="id">knormalize</span><span class="id"> P</span>) (<span class="id">knormalize1</span><span class="id"> P</span>).<br/>
<br/>
<span class="vernacular">End</span><span class="id"> knormalize</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_mnormalize</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span><span class="id"> probability</span><span class="id"> _</span><span class="id"> _</span><span class="id"> of</span><span class="id"> mnormalize</span> (<span class="id">k</span><span class="id"> x</span>)<span class="id"> point]</span><span class="id"> :</span><span class="id"> pprobability</span><span class="id"> Y</span><span class="id"> R</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">apply:</span> (<span class="id">@measurability</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><br/>
&nbsp;&nbsp;(<span class="id">@pset</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> :</span><span class="id"> set</span> (<span class="id">set</span> (<span class="id">pprobability</span><span class="id"> Y</span><span class="id"> R</span>))))<span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
<span class="id">move=&gt;</span><span class="id"> _</span><span class="id"> -[_</span><span class="id"> [r</span><span class="id"> r01]</span><span class="id"> [Ys</span><span class="id"> mYs</span><span class="id"> &lt;-]]</span><span class="id"> &lt;-</span>.<br/>
<span class="id">rewrite</span><span class="id"> /mnormalize</span><span class="id"> /mset</span><span class="id"> /preimage/=</span>.<br/>
<span class="id">apply:</span><span class="id"> emeasurable_fun_infty_o</span><span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
<span class="id">rewrite</span><span class="id"> /mnormalize/=</span>.<br/>
<span class="id">rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="gallina-kwd"> if</span> (<span class="id">k</span><span class="id"> x</span><span class="id"> setT</span><span class="id"> ==</span><span class="id"> 0</span>)<span class="id"> ||</span> (<span class="id">k</span><span class="id"> x</span><span class="id"> setT</span><span class="id"> ==</span><span class="id"> +oo</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">then</span><span class="id"> \d_point</span><span class="id"> Ys</span><span class="gallina-kwd"> else</span><span class="id"> k</span><span class="id"> x</span><span class="id"> Ys</span><span class="id"> *</span> ((<span class="id">fine</span> (<span class="id">k</span><span class="id"> x</span><span class="id"> setT</span>))<span class="id">^-1</span>)<span class="id">%:E</span>))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> x/=;</span><span class="id"> case:</span><span class="id"> ifPn</span>.<br/>
<span class="id">apply:</span><span class="id"> measurable_fun_if</span><span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
<span class="id">-</span><span class="id"> apply:</span> (<span class="id">measurable_fun_bool</span><span class="id"> true</span>)<span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span> (_<span class="id"> :</span><span class="id"> _</span><span class="id"> @^-1`</span><span class="id"> _</span><span class="id"> =</span><span class="id"> [set</span><span class="id"> t</span><span class="id"> |</span><span class="id"> k</span><span class="id"> t</span><span class="id"> setT</span><span class="id"> ==</span><span class="id"> 0]</span><span class="id"> `|`</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[set</span><span class="id"> t</span><span class="id"> |</span><span class="id"> k</span><span class="id"> t</span><span class="id"> setT</span><span class="id"> ==</span><span class="id"> +oo]</span>)<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/seteqP;</span><span class="id"> split=&gt;</span><span class="id"> x</span><span class="id"> /=</span><span class="id"> /orP</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> setTI;</span><span class="id"> apply:</span><span class="id"> measurableU;</span><span class="id"> exact:</span><span class="id"> kernel_measurable_eq_cst</span>.<br/>
<span class="id">-</span><span class="id"> apply/emeasurable_funM;</span><span class="id"> first</span><span class="id"> exact/measurable_funTS/measurable_kernel</span>.<br/>
&nbsp;&nbsp;<span class="id">apply/measurable_EFinP;</span><span class="id"> rewrite</span><span class="id"> setTI</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span> (<span class="id">@measurable_comp</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> [set</span><span class="id"> r</span><span class="id"> :</span><span class="id"> R</span><span class="id"> |</span><span class="id"> r</span><span class="id"> !=</span><span class="id"> 0%R]</span>).<br/>
&nbsp;&nbsp;<span class="id">+</span><span class="id"> exact:</span><span class="id"> open_measurable</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> /=</span><span class="id"> _</span><span class="id"> [x</span><span class="id"> /norP[s0</span><span class="id"> soo]]</span><span class="id"> &lt;-;</span><span class="id"> rewrite</span><span class="id"> -eqe</span><span class="id"> fineK</span><span class="id"> ?ge0_fin_numE</span><span class="id"> ?ltey</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span><span class="id"> apply:</span><span class="id"> open_continuous_measurable_fun</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> apply/in_setP</span><span class="id"> =&gt;</span><span class="id"> x</span><span class="id"> /=</span><span class="id"> x0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> inv_continuous</span>.<br/>
&nbsp;&nbsp;<span class="id">+</span><span class="gallina-kwd"> by</span><span class="id"> apply:</span><span class="id"> measurableT_comp</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> exact/measurable_funS/measurable_kernel</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Section</span><span class="id"> kcomp_def</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d1</span><span class="id"> d2</span><span class="id"> d3</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d1</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d2</span>)<br/>
&nbsp;&nbsp;(<span class="id">Z</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d3</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> l</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>.<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span> (<span class="id">X</span><span class="id"> *</span><span class="id"> Y</span>)<span class="id">%type</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Z</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>.<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> kcomp</span><span class="id"> x</span><span class="id"> U</span><span class="id"> :=</span><span class="id"> \int[l</span><span class="id"> x]_y</span><span class="id"> k</span> (<span class="id">x,</span><span class="id"> y</span>)<span class="id"> U</span>.<br/>
<br/>
<span class="vernacular">End</span><span class="id"> kcomp_def</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> kcomp_is_measure</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d1</span><span class="id"> d2</span><span class="id"> d3</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d1</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d2</span>)<br/>
&nbsp;(<span class="id">Z</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d3</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> l</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> [the</span><span class="id"> measurableType</span><span class="id"> _</span><span class="id"> of</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span><span class="id"> ~&gt;</span><span class="id"> Z</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> kcomp0</span><span class="id"> x</span><span class="id"> :</span><span class="id"> kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x</span><span class="id"> set0</span><span class="id"> =</span><span class="id"> 0</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> /kcomp</span> (<span class="id">eq_integral</span> (<span class="id">cst</span><span class="id"> 0</span>))<span class="id"> ?integral0//</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> measure0</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Let</span><span class="id"> kcomp_ge0</span><span class="id"> x</span><span class="id"> U</span><span class="id"> :</span><span class="id"> 0</span><span class="id"> &lt;=</span><span class="id"> kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x</span><span class="id"> U</span><br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id"> exact:</span><span class="id"> integral_ge0</span>. Qed.</div></details>
<br/>
<span class="vernacular">Let</span><span class="id"> kcomp_sigma_additive</span><span class="id"> x</span><span class="id"> :</span><span class="id"> semi_sigma_additive</span> (<span class="id">kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> U</span><span class="id"> mU</span><span class="id"> tU</span><span class="id"> mUU;</span><span class="id"> rewrite</span><span class="id"> [X</span><span class="gallina-kwd"> in</span><span class="id"> _</span><span class="id"> --&gt;</span><span class="id"> X]</span>(_<span class="id"> :</span><span class="id"> _</span><span class="id"> =</span><br/>
&nbsp;&nbsp;<span class="id">\int[l</span><span class="id"> x]_y</span> (<span class="id">\sum_</span>(<span class="id">n</span><span class="id"> &lt;oo</span>)<span class="id"> k</span> (<span class="id">x,</span><span class="id"> y</span>) (<span class="id">U</span><span class="id"> n</span>)))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">apply:</span><span class="id"> eq_integral</span><span class="id"> =&gt;</span><span class="id"> V</span><span class="id"> _</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/esym/cvg_lim</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> exact/measure_semi_sigma_additive</span>.<br/>
<span class="id">apply/cvg_closeP;</span><span class="id"> split</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> is_cvg_nneseries</span><span class="id"> =&gt;</span><span class="id"> n</span><span class="id"> _;</span><span class="id"> exact:</span><span class="id"> integral_ge0</span>.<br/>
<span class="id">rewrite</span><span class="id"> closeE//</span><span class="id"> integral_nneseries//</span><span class="id"> =&gt;</span><span class="id"> n</span>.<br/>
<span class="id">exact:</span><span class="id"> measurableT_comp</span> (<span class="id">measurable_kernel</span><span class="id"> k</span><span class="id"> _</span> (<span class="id">mU</span><span class="id"> n</span>))<span class="id"> _</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> x</span><span class="id"> :=</span><span class="id"> isMeasure</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> R</span><br/>
&nbsp;&nbsp;(<span class="id">kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x</span>) (<span class="id">kcomp0</span><span class="id"> x</span>) (<span class="id">kcomp_ge0</span><span class="id"> x</span>) (<span class="id">@kcomp_sigma_additive</span><span class="id"> x</span>).<br/>
<br/>
<span class="vernacular">Definition</span><span class="id"> mkcomp</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Z</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span><span class="id"> :=</span><span class="gallina-kwd"> fun</span><span class="id"> x</span><span class="id"> =&gt;</span><br/>
&nbsp;&nbsp;<span class="id">[the</span><span class="id"> measure</span><span class="id"> _</span><span class="id"> _</span><span class="id"> of</span><span class="id"> kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x]</span>.<br/>
<br/>
<span class="vernacular">End</span><span class="id"> kcomp_is_measure</span>.<br/>
<br/>
<span class="vernacular">Notation</span> <span class="id">&quot;l \; k&quot;</span><span class="id"> :=</span> (<span class="id">mkcomp</span><span class="id"> l</span><span class="id"> k</span>)<span class="id"> :</span><span class="id"> ereal_scope</span>.<br/>
<br/>
<span class="vernacular">Module</span><span class="id"> KCOMP_FINITE_KERNEL</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> kcomp_finite_kernel_kernel</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> d3</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">Z</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d3</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>) (<span class="id">l</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<br/>
&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-ker</span><span class="id"> [the</span><span class="id"> measurableType</span><span class="id"> _</span><span class="id"> of</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span><span class="id"> ~&gt;</span><span class="id"> Z</span>).<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_kcomp_finite</span><span class="id"> U</span><span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> ((<span class="id">l</span><span class="id"> \;</span><span class="id"> k</span>)<span class="id"> ^~</span><span class="id"> U</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> mU;</span><span class="id"> apply:</span> (<span class="id">measurable_fun_integral_finite_kernel</span> (<span class="id">k</span><span class="id"> ^~</span><span class="id"> U</span>))<span class="id"> =&gt;</span><span class="id"> //=</span>.<br/>
<span class="id">exact/measurable_kernel</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">isKernel</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Z</span><span class="id"> R</span> (<span class="id">l</span><span class="id"> \;</span><span class="id"> k</span>)<span class="id"> measurable_fun_kcomp_finite</span>.<br/>
<br/>
<span class="vernacular">End</span><span class="id"> kcomp_finite_kernel_kernel</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> kcomp_finite_kernel_finite</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> d3</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">Z</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d3</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> l</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-fker</span><span class="id"> [the</span><span class="id"> measurableType</span><span class="id"> _</span><span class="id"> of</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span><span class="id"> ~&gt;</span><span class="id"> Z</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> mkcomp_finite</span><span class="id"> :</span><span class="id"> measure_fam_uub</span> (<span class="id">kcomp</span><span class="id"> l</span><span class="id"> k</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> /measure_fam_uubP[r</span><span class="id"> hr]</span><span class="id"> :=</span><span class="id"> measure_uub</span><span class="id"> k</span>.<br/>
<span class="id">have</span><span class="id"> /measure_fam_uubP[s</span><span class="id"> hs]</span><span class="id"> :=</span><span class="id"> measure_uub</span><span class="id"> l</span>.<br/>
<span class="id">apply/measure_fam_uubP;</span><span class="gallina-kwd"> exists</span> (<span class="id">PosNum</span><span class="id"> [gt0</span><span class="id"> of</span> (<span class="id">r%:num</span><span class="id"> *</span><span class="id"> s%:num</span>)<span class="id">%R]</span>)<span class="id"> =&gt;</span><span class="id"> x</span><span class="id"> /=</span>.<br/>
<span class="id">apply:</span> (<span class="id">@le_lt_trans</span><span class="id"> _</span><span class="id"> _</span> (<span class="id">\int[l</span><span class="id"> x]__</span><span class="id"> r%:num%:E</span>)).<br/>
&nbsp;&nbsp;<span class="id">apply:</span><span class="id"> ge0_le_integral</span><span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="id"> exact:</span><span class="id"> measurableT_comp</span> (<span class="id">measurable_kernel</span><span class="id"> k</span><span class="id"> _</span><span class="id"> measurableT</span>)<span class="id"> _</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> exact/ltW/hr</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> integral_cst//=</span><span class="id"> EFinM</span><span class="id"> lte_pmul2l</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">Kernel_isFinite</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Z</span><span class="id"> R</span> (<span class="id">l</span><span class="id"> \;</span><span class="id"> k</span>)<span class="id"> mkcomp_finite</span>.<br/>
<br/>
<span class="vernacular">End</span><span class="id"> kcomp_finite_kernel_finite</span>.<br/>
<span class="vernacular">End</span><span class="id"> KCOMP_FINITE_KERNEL</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> kcomp_sfinite_kernel</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> d3</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">Z</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d3</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> l</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> [the</span><span class="id"> measurableType</span><span class="id"> _</span><span class="id"> of</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span><span class="id"> ~&gt;</span><span class="id"> Z</span>.<br/>
<br/>
<span class="vernacular">Import</span><span class="id"> KCOMP_FINITE_KERNEL</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> mkcomp_sfinite</span><span class="id"> :</span><span class="gallina-kwd"> exists</span><span class="id"> k_</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Z</span>)<span class="id">^nat,</span><br/>
&nbsp;&nbsp;<span class="gallina-kwd">forall</span><span class="id"> x</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span> (<span class="id">l</span><span class="id"> \;</span><span class="id"> k</span>)<span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> kseries</span><span class="id"> k_</span><span class="id"> x</span><span class="id"> U</span>.<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> [k_</span><span class="id"> hk_]</span><span class="id"> :=</span><span class="id"> sfinite_kernel</span><span class="id"> k;</span><span class="id"> have</span><span class="id"> [l_</span><span class="id"> hl_]</span><span class="id"> :=</span><span class="id"> sfinite_kernel</span><span class="id"> l</span>.<br/>
<span class="id">have</span><span class="id"> [kl</span><span class="id"> hkl]</span><span class="id"> :</span><span class="gallina-kwd"> exists</span><span class="id"> kl</span><span class="id"> :</span> (<span class="id">R</span>.<span class="id">-fker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Z</span>)<span class="id"> ^nat,</span><span class="gallina-kwd"> forall</span><span class="id"> x</span><span class="id"> U,</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">\esum_</span>(<span class="id">i</span><span class="gallina-kwd"> in</span><span class="id"> setT</span>) (<span class="id">l_</span><span class="id"> i</span>.<span class="id">2</span><span class="id"> \;</span><span class="id"> k_</span><span class="id"> i</span>.<span class="id">1</span>)<span class="id"> x</span><span class="id"> U</span><span class="id"> =</span><span class="id"> \sum_</span>(<span class="id">i</span><span class="id"> &lt;oo</span>)<span class="id"> kl</span><span class="id"> i</span><span class="id"> x</span><span class="id"> U</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span><span class="id"> /ppcard_eqP[f]</span><span class="id"> :</span> (<span class="id">[set:</span><span class="id"> nat]</span><span class="id"> #=</span><span class="id"> [set:</span><span class="id"> nat</span><span class="id"> *</span><span class="id"> nat]</span>)<span class="id">%card</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> card_eq_sym;</span><span class="id"> exact:</span><span class="id"> card_nat2</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">exists</span> (<span class="gallina-kwd">fun</span><span class="id"> i</span><span class="id"> =&gt;</span><span class="id"> [the</span><span class="id"> _</span>.<span class="id">-fker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span><span class="id"> of</span><span class="id"> l_</span> (<span class="id">f</span><span class="id"> i</span>).<span class="id">2</span><span class="id"> \;</span><span class="id"> k_</span> (<span class="id">f</span><span class="id"> i</span>).<span class="id">1]</span>)<span class="id"> =&gt;</span><span class="id"> x</span><span class="id"> U</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span> (<span class="id">reindex_esum</span><span class="id"> [set:</span><span class="id"> nat]</span><span class="id"> _</span><span class="id"> f</span>)<span class="id">//</span><span class="id"> nneseries_esum//</span><span class="id"> fun_true</span>.<br/>
<span class="gallina-kwd">exists</span><span class="id"> kl</span><span class="id"> =&gt;</span><span class="id"> x</span><span class="id"> U</span><span class="id"> mU</span>.<br/>
<span class="id">transitivity</span> ((<span class="id">[the</span><span class="id"> _</span>.<span class="id">-ker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span><span class="id"> of</span><span class="id"> kseries</span><span class="id"> l_]</span><span class="id"> \;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">[the</span><span class="id"> _</span>.<span class="id">-ker</span><span class="id"> _</span><span class="id"> ~&gt;</span><span class="id"> _</span><span class="id"> of</span><span class="id"> kseries</span><span class="id"> k_]</span>)<span class="id"> x</span><span class="id"> U</span>).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> /=</span><span class="id"> /kcomp</span><span class="id"> [in</span><span class="id"> RHS]</span>(<span class="id">eq_measure_integral</span> (<span class="id">l</span><span class="id"> x</span>))<span class="id">;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> *;</span><span class="id"> rewrite</span><span class="id"> hl_</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> eq_integral</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> hk_</span>.<br/>
<span class="id">rewrite</span><span class="id"> /=</span><span class="id"> /kcomp/=</span><span class="id"> integral_nneseries//=;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> n;</span><span class="id"> exact:</span><span class="id"> measurableT_comp</span> (<span class="id">measurable_kernel</span> (<span class="id">k_</span><span class="id"> n</span>)<span class="id"> _</span><span class="id"> mU</span>)<span class="id"> _</span>.<br/>
<span class="id">transitivity</span> (<span class="id">\sum_</span>(<span class="id">i</span><span class="id"> &lt;oo</span>)<span class="id"> \sum_</span>(<span class="id">j</span><span class="id"> &lt;oo</span>) (<span class="id">l_</span><span class="id"> j</span><span class="id"> \;</span><span class="id"> k_</span><span class="id"> i</span>)<span class="id"> x</span><span class="id"> U</span>).<br/>
&nbsp;&nbsp;<span class="id">apply:</span><span class="id"> eq_eseriesr</span><span class="id"> =&gt;</span><span class="id"> i</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> integral_kseries//</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> exact:</span><span class="id"> measurableT_comp</span> (<span class="id">measurable_kernel</span> (<span class="id">k_</span><span class="id"> i</span>)<span class="id"> _</span><span class="id"> mU</span>)<span class="id"> _</span>.<br/>
<span class="id">rewrite</span><span class="id"> /mseries</span><span class="id"> -hkl/=</span>.<br/>
<span class="id">rewrite</span> (_<span class="id"> :</span><span class="id"> setT</span><span class="id"> =</span><span class="id"> setT</span><span class="id"> `*``</span> (<span class="id">fun=&gt;</span><span class="id"> setT</span>))<span class="id">;</span><span class="id"> last</span><span class="gallina-kwd"> by</span><span class="id"> apply/seteqP;</span><span class="id"> split</span>.<br/>
<span class="id">rewrite</span><span class="id"> -</span>(<span class="id">@esum_esum</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span> (<span class="gallina-kwd">fun</span><span class="id"> i</span><span class="id"> j</span><span class="id"> =&gt;</span> (<span class="id">l_</span><span class="id"> j</span><span class="id"> \;</span><span class="id"> k_</span><span class="id"> i</span>)<span class="id"> x</span><span class="id"> U</span>))<span class="id">//</span>.<br/>
<span class="id">rewrite</span><span class="id"> nneseries_esum;</span><span class="id"> last</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> n</span><span class="id"> _;</span><span class="id"> exact:</span><span class="id"> nneseries_ge0</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> fun_true;</span><span class="id"> apply:</span><span class="id"> eq_esum</span><span class="id"> =&gt;</span><span class="id"> /=</span><span class="id"> i</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> nneseries_esum//</span><span class="id"> fun_true</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_mkcomp_sfinite</span><span class="id"> U</span><span class="id"> :</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> ((<span class="id">l</span><span class="id"> \;</span><span class="id"> k</span>)<span class="id"> ^~</span><span class="id"> U</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> mU;</span><span class="id"> apply:</span> (<span class="id">measurable_fun_integral_sfinite_kernel</span> (<span class="id">k</span><span class="id"> ^~</span><span class="id"> U</span>))<span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
<span class="id">exact/measurable_kernel</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> kcomp_sfinite_kernel</span>.<br/>
<br/>
<span class="vernacular">Module</span><span class="id"> KCOMP_SFINITE_KERNEL</span>.<br/>
<span class="vernacular">Section</span><span class="id"> kcomp_sfinite_kernel</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span><span class="id"> d3</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>)<br/>
&nbsp;&nbsp;(<span class="id">Z</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d3</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variable</span><span class="id"> l</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>.<br/>
<span class="vernacular">Variable</span><span class="id"> k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> [the</span><span class="id"> measurableType</span><span class="id"> _</span><span class="id"> of</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span><span class="id"> ~&gt;</span><span class="id"> Z</span>.<br/>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">isKernel</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Z</span><span class="id"> R</span> (<span class="id">l</span><span class="id"> \;</span><span class="id"> k</span>) (<span class="id">measurable_fun_mkcomp_sfinite</span><span class="id"> l</span><span class="id"> k</span>).<br/>
<br/>
<span class="id">#[export]</span><br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> :=</span><br/>
&nbsp;&nbsp;<span class="id">Kernel_isSFinite</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> X</span><span class="id"> Z</span><span class="id"> R</span> (<span class="id">l</span><span class="id"> \;</span><span class="id"> k</span>) (<span class="id">mkcomp_sfinite</span><span class="id"> l</span><span class="id"> k</span>).<br/>
<br/>
<span class="vernacular">End</span><span class="id"> kcomp_sfinite_kernel</span>.<br/>
<span class="vernacular">End</span><span class="id"> KCOMP_SFINITE_KERNEL</span>.<br/>
<span class="id">HB</span>.<span class="id">export</span><span class="id"> KCOMP_SFINITE_KERNEL</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> measurable_fun_preimage_integral</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Import</span><span class="id"> HBNNSimple</span>.<br/>
<span class="vernacular">Variables</span> (<span class="id">k</span><span class="id"> :</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R</span>)<br/>
&nbsp;&nbsp;(<span class="id">k_</span><span class="id"> :</span> (<span class="id">{nnsfun</span><span class="id"> Y</span><span class="id"> &gt;-&gt;</span><span class="id"> R}</span>)<span class="id"> ^nat</span>)<br/>
&nbsp;&nbsp;(<span class="id">ndk_</span><span class="id"> :</span><span class="id"> nondecreasing_seq</span> (<span class="id">k_</span><span class="id"> :</span> (<span class="id">Y</span><span class="id"> -&gt;</span><span class="id"> R</span>)<span class="id">^nat</span>))<br/>
&nbsp;&nbsp;(<span class="id">k_k</span><span class="id"> :</span><span class="gallina-kwd"> forall</span><span class="id"> z,</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> z</span><span class="id"> -&gt;</span> (<span class="id">k_</span><span class="id"> n</span><span class="id"> z</span>)<span class="id">%:E</span><span class="id"> @[n</span><span class="id"> --&gt;</span><span class="id"> \oo]</span><span class="id"> --&gt;</span><span class="id"> k</span><span class="id"> z</span>).<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> k_2</span><span class="id"> :</span> (<span class="id">X</span><span class="id"> *</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> R</span>)<span class="id">^nat</span><span class="id"> :=</span><span class="gallina-kwd"> fun</span><span class="id"> n</span><span class="id"> =&gt;</span><span class="id"> k_</span><span class="id"> n</span><span class="id"> \o</span><span class="id"> snd</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> k_2_ge0</span><span class="id"> n</span><span class="id"> x</span><span class="id"> :</span> (<span class="id">0</span><span class="id"> &lt;=</span><span class="id"> k_2</span><span class="id"> n</span><span class="id"> x</span>)<span class="id">%R</span><br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd"> by</span><span class="id"> []</span>. Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> n</span><span class="id"> :=</span><span class="id"> @isNonNegFun</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span> (<span class="id">k_2_ge0</span><span class="id"> n</span>).<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> mk_2</span><span class="id"> n</span><span class="id"> :</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span> (<span class="id">k_2</span><span class="id"> n</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="gallina-kwd"> by</span><span class="id"> apply:</span><span class="id"> measurableT_comp</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> exact:</span><span class="id"> measurable_snd</span>. Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> n</span><span class="id"> :=</span><span class="id"> @isMeasurableFun</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span> (<span class="id">mk_2</span><span class="id"> n</span>).<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> fk_2</span><span class="id"> n</span><span class="id"> :</span><span class="id"> finite_set</span> (<span class="id">range</span> (<span class="id">k_2</span><span class="id"> n</span>)).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> :=</span><span class="id"> fimfunP</span> (<span class="id">k_</span><span class="id"> n</span>).<br/>
<span class="id">suff</span><span class="id"> :</span><span class="id"> range</span> (<span class="id">k_</span><span class="id"> n</span>)<span class="id"> =</span><span class="id"> range</span> (<span class="id">k_2</span><span class="id"> n</span>)<span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> &lt;-</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply/seteqP;</span><span class="id"> split</span><span class="id"> =&gt;</span><span class="id"> r</span><span class="id"> [y</span><span class="id"> ?]</span><span class="id"> &lt;-;</span><span class="id"> [exists</span> (<span class="id">point,</span><span class="id"> y</span>)<span class="id">|exists</span><span class="id"> y</span>.<span class="id">2]</span>.<br/>
Qed.</div></details>
<br/>
<span class="id">HB</span>.<span class="id">instance</span><span class="vernacular"> Definition</span><span class="id"> _</span><span class="id"> n</span><span class="id"> :=</span><span class="id"> @FiniteImage</span>.<span class="id">Build</span><span class="id"> _</span><span class="id"> _</span><span class="id"> _</span> (<span class="id">fk_2</span><span class="id"> n</span>).<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_preimage_integral</span> (<span class="id">l</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">forall</span><span class="id"> n</span><span class="id"> r,</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">l</span><span class="id"> ^~</span> (<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)))<span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> \int[l</span><span class="id"> x]_z</span><span class="id"> k</span><span class="id"> z</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> h;</span><span class="id"> apply:</span> (<span class="id">measurable_fun_xsection_integral</span> (<span class="id">k</span><span class="id"> \o</span><span class="id"> snd</span>)<span class="id"> l</span><br/>
&nbsp;&nbsp;(<span class="gallina-kwd">fun</span><span class="id"> n</span><span class="id"> =&gt;</span><span class="id"> [the</span><span class="id"> {nnsfun</span><span class="id"> _</span><span class="id"> &gt;-&gt;</span><span class="id"> _}</span><span class="id"> of</span><span class="id"> k_2</span><span class="id"> n]</span>))<span class="id"> =&gt;</span><span class="id"> /=</span>.<br/>
<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> rewrite</span><span class="id"> /k_2</span><span class="id"> =&gt;</span><span class="id"> m</span><span class="id"> n</span><span class="id"> mn;</span><span class="id"> apply/lefP</span><span class="id"> =&gt;</span><span class="id"> -[x</span><span class="id"> y]</span><span class="id"> /=;</span><span class="id"> exact/lefP/ndk_</span>.<br/>
<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> [x</span><span class="id"> y];</span><span class="id"> exact:</span><span class="id"> k_k</span>.<br/>
<span class="id">-</span><span class="id"> move=&gt;</span><span class="id"> n</span><span class="id"> r</span><span class="id"> _</span><span class="id"> /=</span><span class="id"> B</span><span class="id"> mB</span>.<br/>
&nbsp;&nbsp;<span class="id">have</span><span class="id"> :=</span><span class="id"> h</span><span class="id"> n</span><span class="id"> r</span><span class="id"> measurableT</span><span class="id"> B</span><span class="id"> mB;</span><span class="id"> rewrite</span><span class="id"> !setTI</span>.<br/>
&nbsp;&nbsp;<span class="id">suff</span><span class="id"> :</span> (<span class="id">l</span><span class="id"> ^~</span> (<span class="id">k_</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>))<span class="id"> @^-1`</span><span class="id"> B</span><span class="id"> =</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> l</span><span class="id"> x</span> (<span class="id">xsection</span> (<span class="id">k_2</span><span class="id"> n</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="id"> x</span>))<span class="id"> @^-1`</span><span class="id"> B</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> -&gt;</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/seteqP;</span><span class="id"> split</span><span class="id"> =&gt;</span><span class="id"> x/=;</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">comp_preimage</span><span class="id"> _</span><span class="id"> snd</span> (<span class="id">k_</span><span class="id"> n</span>))<span class="id"> xsection_preimage_snd</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> measurable_fun_preimage_integral</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> measurable_fun_integral_kernel</span>.<br/>
<br/>
<span class="vernacular">Import</span><span class="id"> HBNNSimple</span>.<br/>
<br/>
<span class="vernacular">Lemma</span><span class="id"> measurable_fun_integral_kernel</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">d</span><span class="id"> d'</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d'</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">l</span><span class="id"> :</span><span class="id"> X</span><span class="id"> -&gt;</span><span class="id"> {measure</span><span class="id"> set</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R}</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">ml</span><span class="id"> :</span><span class="gallina-kwd"> forall</span><span class="id"> U,</span><span class="id"> measurable</span><span class="id"> U</span><span class="id"> -&gt;</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="id">l</span><span class="id"> ^~</span><span class="id"> U</span>))<br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> Y</span><span class="id"> -&gt;</span><span class="id"> \bar</span><span class="id"> R</span>) (<span class="id">k0</span><span class="id"> :</span><span class="gallina-kwd"> forall</span><span class="id"> z,</span><span class="id"> 0</span><span class="id"> &lt;=</span><span class="id"> k</span><span class="id"> z</span>) (<span class="id">mk</span><span class="id"> :</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> Y]</span><span class="id"> k</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">measurable_fun</span><span class="id"> [set:</span><span class="id"> X]</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> =&gt;</span><span class="id"> \int[l</span><span class="id"> x]_y</span><span class="id"> k</span><span class="id"> y</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">have</span><span class="id"> [k_</span><span class="id"> [ndk_</span><span class="id"> k_k]]</span><span class="id"> :=</span><span class="id"> approximation</span><span class="id"> measurableT</span><span class="id"> mk</span> (<span class="gallina-kwd">fun</span><span class="id"> x</span><span class="id"> _</span><span class="id"> =&gt;</span><span class="id"> k0</span><span class="id"> x</span>).<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span> (<span class="id">measurable_fun_preimage_integral</span><span class="id"> ndk_</span><span class="id"> k_k</span>)<span class="id"> =&gt;</span><span class="id"> n</span><span class="id"> r;</span><span class="id"> exact/ml</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> measurable_fun_integral_kernel</span>.<br/>
<br/>
<span class="vernacular">Section</span><span class="id"> integral_kcomp</span>.<br/>
<span class="vernacular">Context</span><span class="id"> d</span><span class="id"> d2</span><span class="id"> d3</span> (<span class="id">X</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d</span>) (<span class="id">Y</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d2</span>)<br/>
&nbsp;&nbsp;(<span class="id">Z</span><span class="id"> :</span><span class="id"> measurableType</span><span class="id"> d3</span>) (<span class="id">R</span><span class="id"> :</span><span class="id"> realType</span>).<br/>
<span class="vernacular">Variables</span> (<span class="id">l</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> X</span><span class="id"> ~&gt;</span><span class="id"> Y</span>)<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(<span class="id">k</span><span class="id"> :</span><span class="id"> R</span>.<span class="id">-sfker</span><span class="id"> [the</span><span class="id"> measurableType</span><span class="id"> _</span><span class="id"> of</span><span class="id"> X</span><span class="id"> *</span><span class="id"> Y]</span><span class="id"> ~&gt;</span><span class="id"> Z</span>).<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> integral_kcomp_indic</span><span class="id"> x</span><span class="id"> E</span> (<span class="id">mE</span><span class="id"> :</span><span class="id"> measurable</span><span class="id"> E</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">\int[kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x]_z</span> (<span class="id">\1_E</span><span class="id"> z</span>)<span class="id">%:E</span><span class="id"> =</span><span class="id"> \int[l</span><span class="id"> x]_y</span> (<span class="id">\int[k</span> (<span class="id">x,</span><span class="id"> y</span>)<span class="id">]_z</span> (<span class="id">\1_E</span><span class="id"> z</span>)<span class="id">%:E</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">rewrite</span><span class="id"> integral_indic//=</span><span class="id"> /kcomp</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> eq_integral</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> integral_indic</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Import</span><span class="id"> HBNNSimple</span>.<br/>
<br/>
<span class="vernacular">Let</span><span class="id"> integral_kcomp_nnsfun</span><span class="id"> x</span> (<span class="id">f</span><span class="id"> :</span><span class="id"> {nnsfun</span><span class="id"> Z</span><span class="id"> &gt;-&gt;</span><span class="id"> R}</span>)<span class="id"> :</span><br/>
&nbsp;&nbsp;<span class="id">\int[kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x]_z</span> (<span class="id">f</span><span class="id"> z</span>)<span class="id">%:E</span><span class="id"> =</span><span class="id"> \int[l</span><span class="id"> x]_y</span> (<span class="id">\int[k</span> (<span class="id">x,</span><span class="id"> y</span>)<span class="id">]_z</span> (<span class="id">f</span><span class="id"> z</span>)<span class="id">%:E</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">under</span><span class="id"> [in</span><span class="id"> LHS]eq_integral</span><span class="id"> do</span><span class="id"> rewrite</span><span class="id"> fimfunE</span><span class="id"> -fsumEFin//</span>.<br/>
<span class="id">rewrite</span><span class="id"> ge0_integral_fsum//;</span><span class="id"> last</span><span class="id"> 2</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="id"> move=&gt;</span><span class="id"> r;</span><span class="id"> apply/measurable_EFinP/measurableT_comp</span><span class="id"> =&gt;</span><span class="id"> [//|]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span><span class="id"> fr</span><span class="id"> :</span><span class="id"> measurable</span> (<span class="id">f</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="gallina-kwd"> by</span><span class="id"> exact/measurable_sfunP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span> (_<span class="id"> :</span><span class="id"> \1__</span><span class="id"> =</span><span class="id"> mindic</span><span class="id"> R</span><span class="id"> fr</span>).<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> r</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> EFinM</span><span class="id"> nnfun_muleindic_ge0</span>.<br/>
<span class="id">under</span><span class="id"> [in</span><span class="id"> RHS]eq_integral</span>.<br/>
&nbsp;&nbsp;<span class="id">move=&gt;</span><span class="id"> y</span><span class="id"> _</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span><span class="id"> eq_integral</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> fimfunE</span><span class="id"> -fsumEFin//;</span><span class="id"> over</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> /=</span><span class="id"> ge0_integral_fsum//;</span><span class="id"> last</span><span class="id"> 2</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">-</span><span class="id"> move=&gt;</span><span class="id"> r;</span><span class="id"> apply/measurable_EFinP/measurableT_comp</span><span class="id"> =&gt;</span><span class="id"> [//|]</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span><span class="id"> fr</span><span class="id"> :</span><span class="id"> measurable</span> (<span class="id">f</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="gallina-kwd"> by</span><span class="id"> exact/measurable_sfunP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span> (_<span class="id"> :</span><span class="id"> \1__</span><span class="id"> =</span><span class="id"> mindic</span><span class="id"> R</span><span class="id"> fr</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> r</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> EFinM</span><span class="id"> nnfun_muleindic_ge0</span>.<br/>
&nbsp;&nbsp;<span class="id">under</span><span class="id"> eq_fsbigr</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">move=&gt;</span><span class="id"> r</span><span class="id"> _</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span> (<span class="id">integralZl_indic</span><span class="id"> _</span> (<span class="gallina-kwd">fun</span><span class="id"> r</span><span class="id"> =&gt;</span><span class="id"> f</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>))<span class="id">//;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> r0;</span><span class="id"> rewrite</span><span class="id"> preimage_nnfun0</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> integral_indic//</span><span class="id"> setIT</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">over</span>.<br/>
&nbsp;&nbsp;<span class="id">over</span>.<br/>
<span class="id">rewrite</span><span class="id"> /=</span><span class="id"> ge0_integral_fsum//;</span><span class="id"> last</span><span class="id"> 2</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="id"> move=&gt;</span><span class="id"> r;</span><span class="id"> apply:</span><span class="id"> measurable_funeM</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> measurableT_comp</span> (<span class="id">measurable_kernel</span><span class="id"> k</span> (<span class="id">f</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="id"> _</span>)<span class="id"> _</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="id"> move=&gt;</span><span class="id"> n</span><span class="id"> y</span><span class="id"> _</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">have</span><span class="id"> :=</span><span class="id"> mulemu_ge0</span> (<span class="gallina-kwd">fun</span><span class="id"> n</span><span class="id"> =&gt;</span><span class="id"> f</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> n]</span>).<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply;</span><span class="id"> exact:</span><span class="id"> preimage_nnfun0</span>.<br/>
<span class="id">apply:</span><span class="id"> eq_fsbigr</span><span class="id"> =&gt;</span><span class="id"> r</span><span class="id"> _</span>.<br/>
<span class="id">rewrite</span> (<span class="id">integralZl_indic</span><span class="id"> _</span> (<span class="gallina-kwd">fun</span><span class="id"> r</span><span class="id"> =&gt;</span><span class="id"> f</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>))<span class="id">//;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> preimage_nnfun0</span>.<br/>
<span class="id">rewrite</span><span class="id"> /=</span><span class="id"> integral_kcomp_indic;</span><span class="id"> last</span><span class="id"> exact/measurable_sfunP</span>.<br/>
<span class="id">have</span><span class="id"> [r0|r0]</span><span class="id"> :=</span><span class="id"> leP</span><span class="id"> 0%R</span><span class="id"> r</span>.<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> ge0_integralZl//;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">exact:</span><span class="id"> measurableT_comp</span> (<span class="id">measurable_kernel</span><span class="id"> k</span> (<span class="id">f</span><span class="id"> @^-1`</span><span class="id"> [set</span><span class="id"> r]</span>)<span class="id"> _</span>)<span class="id"> _</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> under</span><span class="id"> eq_integral</span><span class="id"> do</span><span class="id"> rewrite</span><span class="id"> integral_indic//</span><span class="id"> setIT</span>.<br/>
<span class="id">rewrite</span><span class="id"> integral0_eq</span><span class="id"> ?mule0;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="id">move=&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> integral0_eq//</span><span class="id"> =&gt;</span><span class="id"> z</span><span class="id"> _</span>.<br/>
&nbsp;&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> preimage_nnfun0//</span><span class="id"> indic0</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> rewrite</span><span class="id"> integral0_eq//</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> preimage_nnfun0//</span><span class="id"> measure0</span><span class="id"> mule0</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">Lemma</span><span class="id"> integral_kcomp</span><span class="id"> x</span><span class="id"> f</span><span class="id"> :</span> (<span class="gallina-kwd">forall</span><span class="id"> z,</span><span class="id"> 0</span><span class="id"> &lt;=</span><span class="id"> f</span><span class="id"> z</span>)<span class="id"> -&gt;</span><span class="id"> measurable_fun</span><span class="id"> [set:</span><span class="id"> Z]</span><span class="id"> f</span><span class="id"> -&gt;</span><br/>
&nbsp;&nbsp;<span class="id">\int[kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x]_z</span><span class="id"> f</span><span class="id"> z</span><span class="id"> =</span><span class="id"> \int[l</span><span class="id"> x]_y</span> (<span class="id">\int[k</span> (<span class="id">x,</span><span class="id"> y</span>)<span class="id">]_z</span><span class="id"> f</span><span class="id"> z</span>).<br/>
<details>
<summary class="toggleproof">Proof.</summary>
<div class="proofscript">
<span class="id">move=&gt;</span><span class="id"> f0</span><span class="id"> mf</span>.<br/>
<span class="id">have</span><span class="id"> [f_</span><span class="id"> [ndf_</span><span class="id"> f_f]]</span><span class="id"> :=</span><span class="id"> approximation</span><span class="id"> measurableT</span><span class="id"> mf</span> (<span class="gallina-kwd">fun</span><span class="id"> z</span><span class="id"> _</span><span class="id"> =&gt;</span><span class="id"> f0</span><span class="id"> z</span>).<br/>
<span class="id">transitivity</span> (<span class="id">\int[kcomp</span><span class="id"> l</span><span class="id"> k</span><span class="id"> x]_z</span> (<span class="id">lim</span> ((<span class="id">f_</span><span class="id"> n</span><span class="id"> z</span>)<span class="id">%:E</span><span class="id"> @[n</span><span class="id"> --&gt;</span><span class="id"> \oo]</span>))).<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/eq_integral</span><span class="id"> =&gt;</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> apply/esym/cvg_lim</span><span class="id"> =&gt;</span><span class="id"> //=;</span><span class="id"> exact:</span><span class="id"> f_f</span>.<br/>
<span class="id">rewrite</span><span class="id"> monotone_convergence//;</span><span class="id"> last</span><span class="id"> 3</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> n;</span><span class="id"> exact/measurable_EFinP</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> n</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> move=&gt;</span><span class="id"> z</span><span class="id"> _</span><span class="id"> a</span><span class="id"> b</span><span class="id"> /ndf_</span><span class="id"> /lefP</span><span class="id"> ab;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
<span class="id">rewrite</span> (_<span class="id"> :</span> (<span class="gallina-kwd">fun</span><span class="id"> _</span><span class="id"> =&gt;</span><span class="id"> _</span>)<span class="id"> =</span><br/>
&nbsp;&nbsp;&nbsp;&nbsp;(<span class="gallina-kwd">fun</span><span class="id"> n</span><span class="id"> =&gt;</span><span class="id"> \int[l</span><span class="id"> x]_y</span> (<span class="id">\int[k</span> (<span class="id">x,</span><span class="id"> y</span>)<span class="id">]_z</span> (<span class="id">f_</span><span class="id"> n</span><span class="id"> z</span>)<span class="id">%:E</span>)))<span class="id">//;</span><span class="id"> last</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="gallina-kwd">by</span><span class="id"> apply/funext</span><span class="id"> =&gt;</span><span class="id"> n;</span><span class="id"> rewrite</span><span class="id"> integral_kcomp_nnsfun</span>.<br/>
<span class="id">transitivity</span> (<span class="id">\int[l</span><span class="id"> x]_y</span><span class="id"> lim</span> ((<span class="id">\int[k</span> (<span class="id">x,</span><span class="id"> y</span>)<span class="id">]_z</span> (<span class="id">f_</span><span class="id"> n</span><span class="id"> z</span>)<span class="id">%:E</span>)<span class="id"> @[n</span><span class="id"> --&gt;</span><span class="id"> \oo]</span>)).<br/>
&nbsp;&nbsp;<span class="id">rewrite</span><span class="id"> -monotone_convergence//;</span><span class="id"> last</span><span class="id"> 3</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="id"> move=&gt;</span><span class="id"> n;</span><span class="id"> apply:</span><span class="id"> measurable_fun_integral_kernel</span><span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">+</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> U</span><span class="id"> mU;</span><span class="id"> exact:</span><span class="id"> measurableT_comp</span> (<span class="id">measurable_kernel</span><span class="id"> k</span><span class="id"> _</span><span class="id"> mU</span>)<span class="id"> _</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">+</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> z;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">+</span><span class="id"> exact/measurable_EFinP</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> n</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> apply:</span><span class="id"> integral_ge0</span><span class="id"> =&gt;</span><span class="id"> //</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="id"> move=&gt;</span><span class="id"> y</span><span class="id"> _</span><span class="id"> a</span><span class="id"> b</span><span class="id"> ab;</span><span class="id"> apply:</span><span class="id"> ge0_le_integral</span><span class="id"> =&gt;</span><span class="id"> //</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">+</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">+</span><span class="id"> exact/measurable_EFinP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">+</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">+</span><span class="id"> exact/measurable_EFinP</span>.<br/>
&nbsp;&nbsp;&nbsp;&nbsp;<span class="id">+</span><span class="gallina-kwd"> by</span><span class="id"> move:</span><span class="id"> ab</span><span class="id"> =&gt;</span><span class="id"> /ndf_</span><span class="id"> /lefP</span><span class="id"> ab</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
<span class="id">apply:</span><span class="id"> eq_integral</span><span class="id"> =&gt;</span><span class="id"> y</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> -monotone_convergence//;</span><span class="id"> last</span><span class="id"> 3</span><span class="id"> first</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> n;</span><span class="id"> exact/measurable_EFinP</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> n</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
&nbsp;&nbsp;<span class="id">-</span><span class="gallina-kwd"> by</span><span class="id"> move=&gt;</span><span class="id"> z</span><span class="id"> _</span><span class="id"> a</span><span class="id"> b</span><span class="id"> /ndf_</span><span class="id"> /lefP;</span><span class="id"> rewrite</span><span class="id"> lee_fin</span>.<br/>
<span class="gallina-kwd">by</span><span class="id"> apply:</span><span class="id"> eq_integral</span><span class="id"> =&gt;</span><span class="id"> z</span><span class="id"> _;</span><span class="id"> apply/cvg_lim</span><span class="id"> =&gt;</span><span class="id"> //;</span><span class="id"> exact:</span><span class="id"> f_f</span>.<br/>
Qed.</div></details>
<br/>
<span class="vernacular">End</span><span class="id"> integral_kcomp</span>.<br/>

      <div class="footer"><hr/>Generated by <a href="https://github.com/yoshihiro503/coq2html/">a fork of coq2html</a></div>
    </div>
  </div>
    </main>
</body>
</html>
